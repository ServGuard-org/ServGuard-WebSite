<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ServGuard | Dashboard Rede</title>
    <link rel="stylesheet" href="../../css/main.css" />
    <link rel="shortcut icon" href="../../assets/svg/logo-white.svg" type="image/x-icon" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>

<body>
    <section id="page-dashboard-rede">
        <header>
            <div class="child-navbar-card-dash-adm">
                <div class="navbar-logo-dash-adm">
                    <img src="../../assets/svg/logo.svg" alt="#logo" />
                </div>
                <div class="navbar-navlink-dash-adm">
                    <ul class="list-navlink-dash-adm">
                        <li>
                            <a href="../dashboard-adm.html" class="link-dash-adm">
                                <img src="../../assets/svg/layout-icon.svg" alt="#icone-layout" />
                            </a>
                            <p class="little-text mt-1">Início</p>
                        </li>
                        <li>
                            <a href="../dashboard-analista.html" class="link-dash-adm">
                                <img src="../../assets/svg/search.svg" alt="#icone-layout" />
                            </a>
                            <p class="little-text mt-1">Detalhes</p>
                        </li>
                        <li>
                            <a href="../gerenciamento-funcionario.html" class="link-dash-adm">
                                <img src="../../assets/svg/func-icon.svg" alt="#icone-funcionario" />
                            </a>
                            <p class="little-text mt-1">Funcionário</p>
                        </li>
                        <li>
                            <a href="../gerenciamento-maquina.html" class="link-dash-adm">
                                <img src="../../assets/svg/server-icon.svg" alt="#icone-" />
                            </a>
                            <p class="little-text mt-1">Máquina</p>
                        </li>
                        <li>
                            <a href="../detalhes-funcionario.html" class="link-dash-adm">
                                <img src="../../assets/svg/perfil-icon.svg" alt="#icone-" />
                            </a>
                            <p class="little-text mt-1">Perfil</p>
                        </li>
                    </ul>
                </div>
                <a href="#" class="navbar-exit-dash-adm" onclick="sairNavbar()">
                    <img src="../../assets/svg/exit-icon.svg" alt="" />
                </a>
            </div>
        </header>
        <main>
            <!-- <div class="dash-rede-topo">
                <h3 class="bold">Análise Histórica de Rede</h3>
                <div class="link-back-seta">
                    <a class="bold text-gray-dark" onclick="voltar()">
                        <div class="icon-trian"></div> Voltar
                    </a>
                </div>
            </div> -->
            <div class="dash-rede-topo">
                <div class="link-back-seta">
                    <a class="bold text-gray-dark" onclick="voltar()">
                        <div class="icon-trian"></div> Voltar para início
                    </a>
                </div>
                <div class="dash-rede-titulo">
                    <h3 class="bold">Análise Histórica de Rede</h3>
                    <div class="dash-rede-select-subtitulo">
                        <p class="bold">Semana:</p>
                        <select id="select-semana" class="select-componente bold dash-rede-cor-atual"
                            style="font-size: 20px;" onchange="selecaoSemana()">
                            <option value="#" selected disabled>Selecione Uma Semana</option>
                        </select>
                        <div class="dash-rede-titulo-cards bold">Comparação com a <span
                                class="dash-rede-cor-anterior">semana
                                anterior <span id="semana_anterior_titulo">(dd/mm/yy)</span>:</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="dash-rede-pai-cards">
                <div class="dash-rede-cards-topo">
                    <p class="bold mb-2" style="margin: 0;">Pacotes Enviados</p>
                    <h1 class="dash-rede-fonte-cards  bold" id="card_pacotes_enviados">
                        <span class="dash-rede-cor-anterior">...</span> x <span class="dash-rede-cor-atual">...</span>
                    </h1>
                </div>
                <div class="dash-rede-cards-topo">
                    <p class="bold mb-2" style="margin: 0;">Pacotes Recebidos</p>
                    <h1 class="dash-rede-fonte-cards  bold" id="card_pacotes_recebidos">
                        <span class="dash-rede-cor-anterior">...</span> x <span class="dash-rede-cor-atual">...</span>
                    </h1>
                </div>
                <div class="dash-rede-cards-topo">
                    <p class="bold mb-2" style="margin: 0;">Megabytes Enviados</p>
                    <h1 class="dash-rede-fonte-cards  bold" id="card_mbs_enviados">
                        <span class="dash-rede-cor-anterior">...</span> x <span class="dash-rede-cor-atual">...</span>
                    </h1>
                </div>
                <div class="dash-rede-cards-topo">
                    <p class="bold mb-2" style="margin: 0;">Megabytes Recebidos</p>
                    <h1 class="dash-rede-fonte-cards  bold" id="card_mbs_recebidos">
                        <span class="dash-rede-cor-anterior">...</span> x <span class="dash-rede-cor-atual">...</span>
                    </h1>
                </div>
                <div class="dash-rede-cards-topo">
                    <p class="bold mb-2" style="margin: 0;">Erros (E/R)</p>
                    <h1 class="dash-rede-fonte-cards  bold" id="card_erros">
                        <span class="dash-rede-cor-anterior">...</span> x <span class="dash-rede-cor-atual">...</span>
                    </h1>
                </div>
                <div class="dash-rede-cards-topo">
                    <p class="bold mb-2" style="margin: 0;">Descartes (E/R)</p>
                    <h1 class="dash-rede-fonte-cards  bold" id="card_descartes">
                        <span class="dash-rede-cor-anterior">...</span> x <span class="dash-rede-cor-atual">...</span>
                    </h1>
                </div>
            </div>
            <div class="dash-rede-pai">
                <div class="dash-rede-coluna-1">

                    <div class="dash-rede-barchart">
                        <div class="dash-rede-barchart-space">
                            <h4 class="bold mb-2" id="titulo-grafico-barra"
                                style="margin-bottom: 0%; border-bottom: 0%; margin-top: 1%;"><span
                                    class="dash-rede-cor-anterior">Semana
                                    <span id="placeholder_semana_anterior">dd/mm/yy</span></span> x <span
                                    class="dash-rede-cor-atual">Semana <span
                                        id="placeholder_semana_atual">dd/mm/yy</span></span></h4>
                            <div style="width: 100%; height: 90%; position: relative;">
                                <canvas class="barplot" id="myBarChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="dash-rede-linRegress">
                        <div class="dash-rede-linRegress-space">
                            <h5 class="bold mb-2" style="text-align: center;">Previsão Por Tendência - Pacotes Env. e
                                Rec. (Todas as Semanas)</h5>
                            <div style="width: 100%; height: 90%; position: relative;">
                                <canvas class="" id="regressionChart" style="width: 618px; height: 309px;"></canvas>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="dash-rede-coluna-2">
                    <div class="dash-rede-coluna-2-area-grafico">
                        <div class="area-grafico-rede" id="div-heatmap">
                            <img src="../../assets/gif/loading.gif" alt="">
                        </div>
                    </div>

                    <div class="dash-rede-card-analise">
                        <div class="dash-rede-dentro-analise">
                            <h5 class="bold">Resultado da Regressão Linear</h5 class="bold">
                            <h5>Coeficiente Angular: <span id="placeholder-coef-ang">3,44</span></h5>
                            <h5>Intercepto: <span id="placeholder-intercepto">0,44</span></h5>
                            <div class="dash-rede-dentro-scroll">
                                <p class="little-text" style="padding: 3%; max-height: 100%;"
                                    id="placeholder-analise-ia"><img src="../../assets/gif/loading.gif" alt=""></p>
                            </div>
                            <h6 class="bold"
                                style="display: flex; align-items: center; justify-content: center; width: 100%;"
                                id="texto-ia">
                                Análise Gerada Por IA <img src="../../assets/svg/SGI-preto.svg"
                                    style="width: 20px; margin-left: 0.5%;" id="icone-ia"></h6>
                        </div>
                        <div class="dash-rede-dentro-divisao"></div>
                        <div class="dash-rede-dentro-historico">
                            <div class="dash-rede-dentro-historico-topo">
                                <div class="dash-rede-itens-rede">
                                    <h4 class="bold">Contagem de Alertas Semana (<span id="placeholder-semana-historico"
                                            class="dash-rede-cor-atual">DD/MM/YY</span>)</h4>
                                    <div class="dash-rede-itens-historico">
                                        <p class="bold" style="font-weight: 700; font-size: 19px;">Pacotes (E/R): <span
                                                id="contagem-pacotes">...</span></p>
                                        <p class="bold" style="font-weight: 700; font-size: 19px;">Megabytes (E/R):
                                            <span id="contagem-megabytes">...</span></p>
                                        <p class="bold" style="font-weight: 700; font-size: 19px;">Erros e Descartes
                                            (E/R): <span id="contagem-errosdesc">...</span></p>
                                    </div>
                                </div>
                            </div>
                            <div class="dash-rede-dentro-historico-baixo">
                                <div class="dash-rede-itens-rede">
                                    <h4 class="bold">Médias Semana (<span id="placeholder-semana-historico"
                                            class="dash-rede-cor-atual">DD/MM/YY</span>)</h4>
                                    <div class="dash-rede-itens-historico">
                                        <p class="bold" style="font-weight: 700; font-size: 19px;">Pacotes (E/R): <span
                                                id="media-pacotes">...</span></p>
                                        <p class="bold" style="font-weight: 700; font-size: 19px;">Megabytes (E/R):
                                            <span id="media-megabytes">...</span></p>
                                        <p class="bold" style="font-weight: 700; font-size: 19px;">Erros e Descartes
                                            (E/R): <span id="media-errosdesc">...</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- <h4 class="italic bold">Contagem de Alertas</h4>
                    <div class="dash-rede-campo-barra">
                        <h5 class="bold italic">Pacotes (E/R): <span id="alertas_pacotes">...</span></h5>
                        <h5 class="bold italic">Megabytes (E/R): <span id="alertas_megabytes">...</span></h5>
                        <h5 class="bold italic">Erros e Descartes (E/R): <span id="alertas_err_desc">...</span></h5>
                    </div>
                    <h4 class="italic bold">Médias</h4>
                    <div class="dash-rede-campo-barra">
                        <h5 class="bold italic">Pacotes (E/R): <span id="media_pacotes">...</span></h5>
                        <h5 class="bold italic">Megabytes (E/R): <span id="media_megabytes">...</span></h5>
                        <h5 class="bold italic">Erros e Descartes (E/R): <span id="media_err_desc">...</span></h5>
                    </div> -->
                </div>
            </div>
        </main>
    </section>
</body>
<script>

    const dados = {}
    let myBarChart = null;

    function calcularRegressaoLinear(x, y) {
        console.log("Input arrays:", x, y);

        // Store original length and make copies of arrays
        const originalLength = x.length;
        let xVals = [...x];
        let yVals = [...y];

        // Remove o último ponto se y for 0 (outlier)
        if (yVals[yVals.length - 1] === 0) {
            xVals = xVals.slice(0, -1);
            yVals = yVals.slice(0, -1);
        }

        const n = xVals.length;
        console.log("After outlier removal - n:", n);

        // Calcula médias com maior precisão
        const xMean = xVals.reduce((sum, xi) => sum + Number(xi), 0) / n;
        const yMean = yVals.reduce((sum, yi) => sum + Number(yi), 0) / n;
        console.log("Means - x:", xMean, "y:", yMean);

        // Calcula coeficientes
        let numerador = 0;
        let denominador = 0;

        for (let i = 0; i < n; i++) {
            const xi = Number(xVals[i]);
            const yi = Number(yVals[i]);
            numerador += (xi - xMean) * (yi - yMean);
            denominador += Math.pow(xi - xMean, 2);
        }

        console.log("Coeficientes - numerador:", numerador, "denominador:", denominador);

        // Evita divisão por zero ou valores muito pequenos
        if (Math.abs(denominador) < 1e-10) {
            console.log("Denominador muito pequeno, retornando média");
            return Array(originalLength).fill(yMean);
        }

        const beta = numerador / denominador;
        const alpha = yMean - beta * xMean;
        console.log("Alpha (Intercepto):", alpha, "Beta (Coef. Angular):", beta);

        // Calcula valores preditos
        const predictions = Array.from(
            { length: originalLength },
            (_, i) => alpha + beta * (i + 1)
        );
        console.log("Predictions:", predictions);

        gerarAnaliseIA({ alpha: alpha, beta: beta })

        return predictions;
    }

    const formatarTextoIA = texto => {
        // Utilizando uma expressão regular para encontrar os textos dentro de **
        return texto
            .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>') // Substitui os negritos
            .replace(/\n/g, '<br>'); // Substitui as quebras de linha
    }

    const formatarSemanas = semana => {
        const dataInicio = new Date(semana.inicio_semana);
        const dataFim = new Date(semana.fim_semana);
        return `${dataInicio.toLocaleDateString()} a ${dataFim.toLocaleDateString()}`;
    }

    const formatarData = data => {
        const dataFormatada = new Date(data);
        return dataFormatada.toLocaleDateString();
    }

    const sairNavbar = () => {
        event.preventDefault();
        sessionStorage.clear();
        window.location.href = "../../index.html";
    }

    const voltar = () => {
        window.location.href = "../dashboard-adm.html";

    }

    const obterSemanas = async () => {
        const select = document.querySelector('#select-semana');
        const idEmpresa = sessionStorage.getItem('ID_EMPRESA_USUARIO');

        try {

            const resposta = await fetch(`/empresas/obterSemanas/${idEmpresa}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                },
            });

            if (!resposta.ok) {
                throw new Error(`Erro na requisição: ${resposta.status} - ${resposta.statusText}`);
            }

            const semanas = await resposta.json();

            dados.semanas = semanas;
            select.innerHTML = ""
            semanas.forEach(semana => {
                const option = document.createElement('option');
                option.value = semana.numero_semana;
                option.innerText = formatarSemanas(semana);
                select.appendChild(option);
            });

            if (semanas.length > 0) {
                select.value = semanas[0].numero_semana;
                selecaoSemana();
            }

        } catch (error) {
            console.error('Erro ao obter semanas:', error);
        }
    };

    const atualizarContagensMedias = () => {
        const elementosData = document.querySelectorAll('#placeholder-semana-historico');
        console.log(elementosData)
        const data = formatarData(dados.semana.inicio_semana);
        elementosData.forEach(ed => ed.innerHTML = data)
    }

    const gerarAnaliseIA = dadosRegressaoLinear => {

        const elementoAng = document.getElementById('placeholder-coef-ang');
        const elementoInt = document.getElementById('placeholder-intercepto');

        elementoAng.innerHTML = `${Math.round(dadosRegressaoLinear.beta, 2)}`;
        elementoInt.innerHTML = `${Math.round(dadosRegressaoLinear.alpha, 2)}`;

        const dadosPreparados = `Coeficiente Angular: ${dadosRegressaoLinear.beta}, Intercepto: ${dadosRegressaoLinear.alpha}`;

        let mensagem = `
        Uma regressão linear, com resultado: ${dadosPreparados} foi gerada, onde Y é o número de pacotes enviados e recebidos e X são os dias. Com base nela,
        gere uma análise de tendência para a empresa. Esta regressão linear utilizou os dados de pacotes 
        enviados e recebidos de todos os servidores desta empresa. Faça uma análise sem citar nomes técnicos.
        Faça, ao final, um comentário geral sobre os resultados obtidos.
        `;

        fetch(`/externos/GenAI/perguntar`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                pergunta: mensagem.toString()
            })
        }
        ).then(resposta => resposta.json().then(respostaFormatada => {
            respostaFormatada = formatarTextoIA(respostaFormatada.resposta.toString());
            console.log('Resposta IA:', respostaFormatada);
            const elementoAnalise = document.getElementById('placeholder-analise-ia');
            elementoAnalise.innerHTML = respostaFormatada;
        })).catch(error => {
            console.error('Erro ao obter resposta IA:', error);
        });

    }


    const atualizarGraficoBarras = valores => {
        if (myBarChart) {
            myBarChart.destroy();
        }

        const dadosAtuais = valores.map(v => v.semanaAtual);
        const dadosAntigos = valores.map(v => v.semanaPassada);

        var ctx = document.querySelector('#myBarChart').getContext('2d');

        const data = {
            labels: ['Pacotes Env.', 'Pacotes Rec.', 'MB Env.', 'MB Rec.', 'Erros', 'Descartes'],
            datasets: [
                {
                    label: `Semana Anterior (${formatarData(dados.semanaAnterior.inicio_semana)})`,
                    data: dadosAntigos,
                    backgroundColor: 'rgba(78, 122, 212, 0.4)',
                    borderColor: 'rgba(78, 122, 212, 1)',
                    borderWidth: 1
                },
                {
                    label: `Semana Selecionada (${formatarData(dados.semana.inicio_semana)})`,
                    data: dadosAtuais,
                    backgroundColor: 'rgba(121, 78, 212, 0.4)',
                    borderColor: 'rgba(121, 78, 212, 1)',
                    borderWidth: 1
                }
            ]
        };

        const config = {
            type: 'bar',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        ticks: {
                            color: 'black',
                            font: {
                                size: 11,
                                weight: 'bold'
                            }
                        }
                    },
                    y: {
                        type: 'logarithmic',
                        beginAtZero: true,
                        min: 1,
                        ticks: {
                            display: false
                        },
                        grid: {
                            display: false
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                    }
                },
                barPercentage: 0.8,
                categoryPercentage: 0.9
            }
        };

        myBarChart = new Chart(ctx, config);
    }

    const atualizarRegressaoLinearInterface = dados => {

        // Utilizando números sequenciais como valores de x
        const x_values = dados.map((_, index) => index + 1);
        const y_values = dados.map(d => d.total_pacotes);

        const regressao = calcularRegressaoLinear(x_values, y_values);

        console.log('regressao ', regressao);

        regressao.forEach((r, i) => {
            console.log(`X: ${x_values[i]} - Y: ${y_values[i]} - Y_hat: ${r}`);
        });

        // Valores preditos pela regressão
        const y_hat = regressao;

        // Criando o gráfico
        var ctx = document.getElementById('regressionChart');
        const mixedChart = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [
                    {
                        type: 'line',
                        label: `Linha de Projeção`,
                        data: x_values.map((x, i) => ({ x, y: y_hat[i] })),
                        borderColor: 'rgb(121, 78, 212)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        tension: 0.3,
                    },
                    {
                        type: 'scatter',
                        label: 'Valores Reais',
                        data: x_values.map((x, i) => ({ x, y: y_values[i] })),
                        backgroundColor: 'rgb(0, 0, 0)',
                        pointRadius: 5,
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: "Regressão Linear Simples",
                        font: {
                            size: 20,
                            weight: 'bold'
                        },
                        color: '#000',
                        align: 'center'
                    }
                },
                scales: {
                    x: {
                        type: 'linear',
                        position: 'bottom',
                        title: {
                            display: true,
                            text: 'Observações (Dias)',
                            color: 'black',
                            font: {
                                size: 15,
                                weight: 'bold'
                            }
                        },
                        ticks: {
                            color: 'black',
                            font: {
                                size: 12,
                                weight: 'bold'
                            }
                        },
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Total de Pacotes',
                            color: 'black',
                            font: {
                                size: 15,
                                weight: 'bold'
                            }
                        },
                        ticks: {
                            color: 'black',
                            font: {
                                size: 13,
                                weight: 'bold'
                            }
                        },
                    }
                }
            }
        });

    }

    const atualizarRegressaoLinear = () => {
        fetch(`/empresas/obterPacotes/${sessionStorage.getItem('ID_EMPRESA_USUARIO')}`, {
            headers: {
                'Content-Type': 'application/json',
            }
        }).then(resposta => resposta.json().then(respostaFormatada => {
            console.log('Pacotes por dia: ', respostaFormatada)
            atualizarRegressaoLinearInterface(respostaFormatada);
        }).catch(error => {
            console.error('Erro ao obter pacotes:', error);
        }))

    }

    const atualizarCards = numeroSemana => {
        const dadosSemanas = {};

        Promise.all([
            fetch(`/empresas/obterCards/${sessionStorage.getItem("ID_EMPRESA_USUARIO")}/${numeroSemana}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            }).then(resposta => resposta.json().then(respostaFormatada => {

                dadosSemanas.semanaAtual = respostaFormatada[0][0];

            })),
            fetch(`/empresas/obterCards/${sessionStorage.getItem("ID_EMPRESA_USUARIO")}/${numeroSemana - 1}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            }).then(resposta => resposta.json().then(respostaFormatada => {

                dadosSemanas.semanaPassada = respostaFormatada[0][0];

            }))
        ]).then(() => {
            atualizarCardsInterface(dadosSemanas);
        }).catch(error => {
            console.error('Erro ao obter dados:', error);
        });

    }

    const atualizarCardsInterface = dadosSemanas => {
        const cardPacotesEnviados = document.getElementById('card_pacotes_enviados');
        const cardPacotesRecebidos = document.getElementById('card_pacotes_recebidos');
        const cardMbsEnviados = document.getElementById('card_mbs_enviados');
        const cardMbsRecebidos = document.getElementById('card_mbs_recebidos');
        const cardErros = document.getElementById('card_erros');
        const cardDescartes = document.getElementById('card_descartes');

        const semanaPassada = dadosSemanas.semanaPassada;
        const semanaAtual = dadosSemanas.semanaAtual;

        const listaElementos = [cardPacotesEnviados, cardPacotesRecebidos, cardMbsEnviados, cardMbsRecebidos, cardErros, cardDescartes];

        const valores = [
            { semanaPassada: semanaPassada.total_pacotes_enviados, semanaAtual: semanaAtual.total_pacotes_enviados },
            { semanaPassada: semanaPassada.total_pacotes_recebidos, semanaAtual: semanaAtual.total_pacotes_recebidos },
            { semanaPassada: semanaPassada.total_megabytes_enviados, semanaAtual: semanaAtual.total_megabytes_enviados },
            { semanaPassada: semanaPassada.total_megabytes_recebidos, semanaAtual: semanaAtual.total_megabytes_recebidos },
            { semanaPassada: semanaPassada.total_erros, semanaAtual: semanaAtual.total_erros },
            { semanaPassada: semanaPassada.total_descartes, semanaAtual: semanaAtual.total_descartes }
        ];

        listaElementos.forEach((elemento, index) => {
            const valor = valores[index];
            if (valor.semanaPassada >= valor.semanaAtual) {
                if (index >= 4) {
                    var imagemSeta = '<img src="../../assets/svg/arrow-down-green.svg" alt="">';
                } else {
                    var imagemSeta = '<img src="../../assets/svg/arrow-down.svg" alt="">';
                }
            } else {
                if (index >= 4) {
                    var imagemSeta = '<img src="../../assets/svg/arrow-up-red.svg" alt="">';
                } else {
                    var imagemSeta = '<img src="../../assets/svg/arrow-up.svg" alt="">';
                }
            }
            elemento.innerHTML = `<span class="dash-rede-cor-anterior">${parseInt(valor.semanaPassada)}</span> x <span class="dash-rede-cor-atual">${parseInt(valor.semanaAtual)}</span>${imagemSeta}`;
        });

        atualizarGraficoBarras(valores);

    }

    const atualizarMapaInterface = dadosMapa => {

        // Criando um array de datas únicas	
        // Por ser um set, não aceita datas duplicadas
        // ... (spread operator) para transformar o set em array de volta
        // sort para ordenar as datas em ordem crescente
        // map para transformar as datas em objetos
        // exemplo do map: 
        // "2021-09-01" => { name: "01/09/2021", data: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10] }
        const datas = [...new Set(dadosMapa[0].map(dm => dm.data))].sort();

        console.log('DadosMapa', dadosMapa);
        console.log('Datas:', datas);

        // Criando um array de objetos com as datas e os registros do dia
        // para cada data, filtrar os registros do dia
        // e transformar em um objeto com a data e os registros
        // converte os totais para inteiro (os dados já vem com casas decimais 0,
        // mas estou removendo as casas para melhor visualização)
        // e retorna o objeto
        const series = datas.map(data => {
            const registrosDoDia = dadosMapa[0].filter(dm => dm.data === data);
            return {
                name: formatarData(data),
                data: registrosDoDia.map(r => parseInt(r.total_pacotes))
            };
        });

        const options = {
            series: series,
            chart: {
                height: 300,
                width: 825,
                type: 'heatmap',
            },
            dataLabels: {
                enabled: false
            },
            colors: ["#6C2BB3"],
            title: {
                text: `Mapa de Calor - Pacotes (E/R) por Hora`,
                offsetY: 15,
                offsetX: 250,
                style: {
                    fontSize: '20px',
                    fontWeight: 'bold'
                }
            },
            xaxis: {
                categories: Array.from({ length: 24 }, (_, i) =>
                    `${String(i).padStart(2, '0')}:00`
                ),
                title: {
                    text: 'Horas do Dia',
                    offsetY: -10,
                    style: {
                        fontSize: '15px'
                    }
                }
            },
            yaxis: {
                title: {
                    text: 'Dias da Semana',
                    style: {
                        fontSize: '15px'
                    }
                },
                labels: {
                    style: {
                        fontSize: '15px'
                    }
                }
            }
        };

        document.querySelector("#chart").innerHTML = '';
        var chart = new ApexCharts(document.querySelector("#chart"), options);
        chart.render();
    }

    const atualizarMapa = numeroSemana => {

        const divMapa = document.getElementById('div-heatmap');

        divMapa.innerHTML = `<img src="../../assets/gif/loading.gif" alt="">`

        fetch(`/empresas/obterMapaSemana/${sessionStorage.getItem("ID_EMPRESA_USUARIO")}/${numeroSemana}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        }).then(resposta => resposta.json().then(respostaFormatada => {
            divMapa.innerHTML = `<div id="chart" style="width: 100%; height: 100%; margin: 0 auto;min-height: none;max-height: 275px !important;"></div>`
            console.log('Mapa de calor:', respostaFormatada);
            atualizarMapaInterface(respostaFormatada);
        })).catch(error => {
            console.error('Erro ao obter mapa de calor:', error);
        });
    }

    const selecaoSemana = () => {
        const select = document.querySelector('#select-semana');
        const semanaNumero = select.value;
        const semanaSelecionada = dados.semanas.find(s => s.numero_semana == semanaNumero);
        const semanaAnterior = dados.semanas.find(s => s.numero_semana == (semanaNumero - 1));
        const inicioSemanaSelecionada = semanaSelecionada.inicio_semana;
        const inicioSemanaAnterior = semanaAnterior.inicio_semana;

        const elementoSemanaAnterior = document.getElementById('semana_anterior_titulo');
        elementoSemanaAnterior.innerHTML = `(${formatarData(inicioSemanaAnterior)})`;


        const elementoTituloGraficoBarras = document.getElementById('titulo-grafico-barra');

        elementoTituloGraficoBarras.innerHTML = `<span class="dash-rede-cor-anterior">Semana <span
                                        id="placeholder_semana_anterior">${formatarData(inicioSemanaAnterior)}</span></span> x <span
                                    class="dash-rede-cor-atual">Semana <span
                                        id="placeholder_semana_atual">${formatarData(inicioSemanaSelecionada)}</span></span></h4>`

        dados.semana = semanaSelecionada;
        dados.semanaAnterior = semanaAnterior;

        atualizarCards(semanaNumero);
        atualizarMapa(semanaNumero);
        atualizarRegressaoLinear();
        atualizarContagensMedias();

    }

    document.onload = obterSemanas();

</script>