<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ServGuard | Ger. Máquina</title>
    <link rel="stylesheet" href="../css/main.css">
    <link rel="shortcut icon" href="../assets/svg/logo-white.svg" type="image/x-icon" />
    <!-- IMPORTANDO A BIBLIOTECA DO SWEETALERT -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body onload="document.getElementById('pai-maquinas').innerHTML = '';
consultarMaquinas()">
    <!-- ----- TELA PRINCIPAL ----- -->
    <section id="page-gerenciamento-maquina">
        <header>
            <div class="child-navbar-card-dash-adm">
                <div class="navbar-logo-dash-adm">
                    <img src="../assets/svg/logo.svg" alt="#logo">
                </div>

                <div class="navbar-navlink-dash-adm">
                    <ul class="list-navlink-dash-adm">
                        <li>
                            <a href="./dashboard-adm.html" class="link-dash-adm">
                                <img src="../assets/svg/layout-icon.svg" alt="#icone-layout">
                            </a>
                            <p class="little-text mt-1">Início</p>
                        </li>
                        <li>
                            <a href="dashboard-analista.html" class="link-dash-adm">
                              <img
                                src="../assets/svg/search.svg"
                                alt="#icone-layout"
                              />
                            </a>
                            <p class="little-text mt-1">Detalhes</p>
                          </li>
                        <li>
                            <a href="./gerenciamento-funcionario.html" class="link-dash-adm">
                                <img src="../assets/svg/func-icon.svg" alt="#icone-func">
                            </a>
                            <p class="little-text mt-1">Funcionário</p>
                        </li>
                        <li>
                            <a href="./gerenciamento-maquina.html" class="link-dash-adm active">
                                <img src="../assets/svg/server-icon-white.svg" alt="#icone-">
                            </a>
                            <p class="little-text mt-1">Máquina</p>
                        </li>
                        <li>
                            <a href="detalhes-funcionario.html" class="link-dash-adm">
                                <img src="../assets/svg/perfil-icon.svg" alt="#icone-">
                            </a>
                            <p class="little-text mt-1">Perfil</p>
                        </li>
                    </ul>
                </div>

                <a href="#" class="navbar-exit-dash-adm" onclick="sairNavbar()">
                    <img src="../assets/svg/exit-icon.svg" alt="">
                </a>
            </div>
        </header>

        <!-- //// FIM NAVBAR //// -->

        <main>

            <div class="father-maquina-card">
                <h3 class="bold">Gerenciamento de máquinas:</h3>
                <div class="child-maquina-card" style="background-color: var(--dark-purple);">
                    <p class="bold text-white italic">Total: <span id="num_total"></span></p>
                </div>
                <div class="child-maquina-card">
                    <p class="bold italic">Ativas: <span id="num_ana"></span></p>
                </div>
                <div class="child-maquina-card">
                    <p class="bold italic">Inativas: <span id="num_adms"></span></p>
                </div>
            </div>


            <div class="father-maquina-lista">
                <div class="child-maquina-colunas">
                    <!-- apenas para alinhar -->
                    <a href="#" class="child-elemento-editar"></a>
                    </a>
                    <div class="child-maquina-elemento-father-colunas">

                        <div class="child-maquina-elemento-coluna-area-id">
                            <p class="bold">ID</p>
                        </div>
                        <div class="child-maquina-elemento-coluna-area-nome">
                            <p class="bold">Nome</p>
                        </div>
                        <div class="child-maquina-elemento-coluna-area-apelido">
                            <p class="bold">Apelido</p>
                        </div>
                        <div class="child-maquina-elemento-coluna-area-cpu">
                            <p class="bold">CPU</p>
                        </div>
                        <div class="child-maquina-elemento-coluna-area-ram">
                            <p class="bold">RAM</p>
                        </div>
                        <div class="child-maquina-elemento-coluna-area-armazenamento">
                            <p class="bold">Armazenamento</p>
                        </div>
                        <div class="child-maquina-elemento-coluna-area-acao"></div>
                    </div>
                </div>
                <div class="child-maquina-father-elemento" id="pai-maquinas">
                    <!-- <div class="child-maquina-elemento">
                        <a href="#" class="child-elemento-editar" onclick="exibirEditar()">
                            <img src="../assets/svg/edit.svg" alt="#icone-">
                        </a>
                        <div class="child-maquina-elemento-infos">
                            
                            <div class="child-maquina-elemento-info-area-id">
                                <p>13</p>
                            </div>
                            <div class="child-maquina-elemento-info-area-nome">
                                <p>Desktop-03</p>
                            </div>
                            <div class="child-maquina-elemento-info-area-apelido">
                                <p>Controle 1</p>
                            </div>
                            <div class="child-maquina-elemento-info-area-cpu">
                                <p>Intell Core i5 12th gen</p>
                            </div>
                            <div class="child-maquina-elemento-info-area-ram">
                                <p>32GB</p>
                            </div>
                            <div class="child-maquina-elemento-info-area-armazenamento">
                                <p>500Gb de 1000Gb</p>
                            </div>
                            <div class="child-maquina-elemento-info-area-acao">
                                <button class="bold underline italic botao-acao"
                                    onclick="DetalhesMaquina()">Detalhes</button>
                            </div>
                        </div>
                    </div> -->
                </div>
            </div>
        </main>
    </section>
    <!-- ----- FIM - TELA PRINCIPAL ----- -->

    <!-- ----- POPUP DE EDITAR MAQUINA ----- -->
    <section class="sessao-popup" id="popupEditar" style="display: none;">
        <div class="father-editar-maquina">
            <h3 class="bold">Altere o campo que quiser e clique em "<span
                    style="color: var(--dark-purple);">atualizar</span>"</h3>
            <div class="child-campos">
                <div class="child-input">
                    <a class="icone-input">
                        <img src="../assets/svg/computer-icon.svg" alt="iconeNome">
                    </a>
                    <input type="text" class="input-popup" placeholder="Apelido da Máquina" id="input_apelido">
                </div>
                <h5 class="bold">Parâmetros para Disparo de Alertas:</h5>
                <div class="child-input">
                    <a class="icone-input">
                        <img src="../assets/svg/cpu-icon.svg" alt="iconeNome">
                    </a>
                    <input type="number" class="input-popup" placeholder="Uso de CPU(%)" id="input_cpu">
                </div>
                <div class="child-input">
                    <a class="icone-input">
                        <img src="../assets/svg/ram-icon.svg" alt="iconeNome">
                    </a>
                    <input type="number" class="input-popup" placeholder="Uso de RAM(%)" id="input_ram">
                </div>
            </div>
            <div class="father-popup-botao">
                <button class="botao-cadastrar-executar" id="botao_atualizar"><b>Atualizar</b></button>
                <p onclick="sairEditar()" class="botao-cadastrar-cancelar italic underline bold">Sair</p>
            </div>
        </div>
    </section>

</body>
<script>
    function sairNavbar() {
        event.preventDefault();
        sessionStorage.clear();
        window.location.href = "../index.html";
    }

    function DetalhesMaquina(idMaquina) {
        sessionStorage.setItem("ID_MAQUINA", idMaquina);
        window.location.href = "details-machine.html";
    }

    function exibirEditar(idMaquina) {
        listarPorId(idMaquina);
        document.getElementById('popupEditar').style.display = 'flex'; // Exibe o popup corretamente
    }
    function sairEditar() {
        document.getElementById("input_apelido").value = "";
        document.getElementById("input_ram").value = "";
        document.getElementById("input_cpu").value = "";
        document.getElementById('popupEditar').style.display = 'none'; // Exibe o popup corretamente
    }

    function adicionarMaquina(idMaquina, nome, apelido, cpu, ram, armazenamentoUsado, armazenamentoTotal) {

        console.log("chamou adicionarMaquina()!!!!!!!!!!!!!!!!")

        const elementoPai = document.getElementById("pai-maquinas");

        const novoElemento = `<div class="child-maquina-elemento">
                        <a href="#" class="child-elemento-editar" onclick="exibirEditar(${idMaquina})">
                            <img src="../assets/svg/edit.svg" alt="#icone-">
                        </a>
                        <div class="child-maquina-elemento-infos">
                            <!-- minha ideia e dar uma porcentagem para cada elemento exibido  -->
                            <div class="child-maquina-elemento-info-area-id">
                                <p>${idMaquina}</p>
                            </div>
                            <div class="child-maquina-elemento-info-area-nome">
                                <p>${nome}</p>
                            </div>
                            <div class="child-maquina-elemento-info-area-apelido">
                                <p>${apelido}</p>
                            </div>
                            <div class="child-maquina-elemento-info-area-cpu">
                                <p>${cpu}</p>
                            </div>
                            <div class="child-maquina-elemento-info-area-ram">
                                <p>${ram}GB</p>
                            </div>
                            <div class="child-maquina-elemento-info-area-armazenamento">
                                <p>${armazenamentoUsado}GB de ${armazenamentoTotal}GB</p>
                            </div>
                            <div class="child-maquina-elemento-info-area-acao">
                                <button class="bold underline italic botao-acao"
                                    onclick="DetalhesMaquina(${idMaquina})">Detalhes</button>
                            </div>
                        </div>
                    </div>`;

        elementoPai.innerHTML += novoElemento;
    }

    function consultarMaquinas() {
        document.getElementById("pai-maquinas").innerHTML = "";
        const idEmpresa = sessionStorage.getItem("ID_EMPRESA_USUARIO");

        fetch(`/maquinas/listarPorEmpresa/${idEmpresa}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            }
        })
            .then(response => response.json())
            .then(data => {
                document.getElementById("num_total").innerText = data.length;

                const maquinasAtivas = data.filter(maquina => maquina.isAtiva === 1);
                document.getElementById("num_ana").innerText = maquinasAtivas.length;

                const maquinasInativas = data.filter(maquina => maquina.isAtiva === 0);
                document.getElementById("num_adms").innerText = maquinasInativas.length;

                data.forEach(maquina => {
                    adicionarMaquina(maquina.idMaquina, maquina.nome, maquina.apelido, maquina.modeloCPU, Math.ceil(maquina.capacidadeRAM), parseInt(maquina.discoUsado), parseInt(maquina.discoTotal));
                });
            });

    }

    function listarPorId(idMaquina) {
        fetch(`/maquinas/listarPorId/${idMaquina}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            }
        })
            .then(response => response.json())
            .then(data => {
                document.getElementById("input_apelido").value = data[0].apelido;
            }).catch(error => {
                console.error("Erro ao listar por id: ", error);
            });


        fetch(`/maquinas/listarAlertaPorId/${idMaquina}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            }
        })
            .then(response => response.json())
            .then(data => {
                data.forEach(alerta => {
                    if (alerta.recursoNome === "usoCPU") {
                        document.getElementById("input_cpu").value = alerta.maxRecurso;
                    } else if (alerta.recursoNome === "usoRAM") {
                        document.getElementById("input_ram").value = alerta.maxRecurso;
                    }
                });

                botao = document.getElementById("botao_atualizar");

                botao.setAttribute('onclick', `atualizarDados(${data[0].idMaquina})`);

            }).catch(error => {
                console.error("Erro ao listar parametros por maquina: ", error);
            });
    }

    function atualizarDados(idMaquina) {
        const apelido = document.getElementById("input_apelido").value;
        const cpu = document.getElementById("input_cpu").value;
        const ram = document.getElementById("input_ram").value;

        if (apelido !== "indefinido") {
            fetch(`/maquinas/atualizarApelidoPorId`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    idMaquina: idMaquina,
                    apelido: apelido
                })
            })
                .then(response => {
                    if (response.ok) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Dados atualizados com sucesso!',
                            showConfirmButton: false,
                            timer: 1500
                        });
                    }

                    response.json()
                })
                .then(data => {
                    console.log("Atualizado com sucesso: ", data);
                }).catch(error => {
                    console.error("Erro ao atualizar: ", error);
                });
        }
        const body = {
            usoCPU: cpu || null,  // Se cpu estiver definido, usa seu valor; caso contrário, usa null
            usoRAM: ram || null   // Se ram estiver definido, usa seu valor; caso contrário, usa null
        };

        fetch(`/alertas/atualizarPorMaquina/${idMaquina}`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(body)
        })
            .then(response => {
                if (response.ok) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Dados atualizados com sucesso!',
                        showConfirmButton: false,
                        timer: 1500
                    });
                }
                response.json()
                    .then(data => {
                        document.getElementById("pai-maquinas").innerHTML = "";
                        consultarMaquinas();
                        console.log("Atualizado com sucesso: ", data);
                    });
            })
            .catch(error => {
                console.error("Erro ao atualizar: ", error);
            });

        sairEditar();
    }

</script>

</html>