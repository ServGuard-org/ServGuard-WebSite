<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ServGuard | Dashboard Rede</title>
    <link rel="stylesheet" href="../../css/main.css" />
    <link rel="shortcut icon" href="../../assets/svg/logo-white.svg" type="image/x-icon" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>

<body>
    <section id="page-dashboard-rede">
        <header>
            <div class="child-navbar-card-dash-adm">
                <div class="navbar-logo-dash-adm">
                    <img src="../../assets/svg/logo.svg" alt="#logo" />
                </div>
                <div class="navbar-navlink-dash-adm">
                    <ul class="list-navlink-dash-adm">
                        <li>
                            <a href="../dashboard-adm.html" class="link-dash-adm">
                                <img src="../../assets/svg/layout-icon.svg" alt="#icone-layout" />
                            </a>
                            <p class="little-text mt-1">Início</p>
                        </li>
                        <li>
                            <a href="../dashboard-analista.html" class="link-dash-adm">
                                <img src="../../assets/svg/search.svg" alt="#icone-layout" />
                            </a>
                            <p class="little-text mt-1">Detalhes</p>
                        </li>
                        <li>
                            <a href="../gerenciamento-funcionario.html" class="link-dash-adm">
                                <img src="../../assets/svg/func-icon.svg" alt="#icone-funcionario" />
                            </a>
                            <p class="little-text mt-1">Funcionário</p>
                        </li>
                        <li>
                            <a href="../gerenciamento-maquina.html" class="link-dash-adm">
                                <img src="../../assets/svg/server-icon.svg" alt="#icone-" />
                            </a>
                            <p class="little-text mt-1">Máquina</p>
                        </li>
                        <li>
                            <a href="../detalhes-funcionario.html" class="link-dash-adm">
                                <img src="../../assets/svg/perfil-icon.svg" alt="#icone-" />
                            </a>
                            <p class="little-text mt-1">Perfil</p>
                        </li>
                    </ul>
                </div>
                <a href="#" class="navbar-exit-dash-adm" onclick="sairNavbar()">
                    <img src="../../assets/svg/exit-icon.svg" alt="" />
                </a>
            </div>
        </header>
        <main>
            <div class="dash-rede-topo">
                <h1 class="bold">Monitoramento de Rede</h1>
                <div class="link-back-seta">
                    <a class="bold text-gray-dark" onclick="voltar()">
                        <div class="icon-trian"></div> Voltar
                    </a>
                </div>
            </div>
            <div class="dash-rede-subtitulo">
                <h3 class="bold center">Semana:</h3>
                <select id="select-semana" class="select-componente bold dash-rede-cor-atual"
                    onchange="selecaoSemana()">
                    <option value="#" selected disabled>Selecione Uma Semana</option>
                </select>
            </div>
            <div class="dash-rede-titulo-cards bold">Comparação com a <span class="dash-rede-cor-anterior">semana
                    anterior <span id="semana_anterior_titulo">(dd/mm/yy)</span>:</span>
            </div>
            <div class="dash-rede-pai-cards">
                <div class="dash-rede-cards-topo">
                    <p class="bold mb-2">Pacotes Enviados</p>
                    <h1 class="dash-rede-fonte-cards  bold" id="card_pacotes_enviados">
                        <span class="dash-rede-cor-anterior">...</span> x <span class="dash-rede-cor-atual">...</span>
                    </h1> 
                </div>
                <div class="dash-rede-cards-topo">
                    <p class="bold mb-2">Pacotes Recebidos</p>
                    <h1 class="dash-rede-fonte-cards  bold" id="card_pacotes_recebidos">
                        <span class="dash-rede-cor-anterior">...</span> x <span class="dash-rede-cor-atual">...</span>
                    </h1>
                </div>
                <div class="dash-rede-cards-topo">
                    <p class="bold mb-2">Megabytes Enviados</p>
                    <h1 class="dash-rede-fonte-cards  bold" id="card_mbs_enviados">
                        <span class="dash-rede-cor-anterior">...</span> x <span class="dash-rede-cor-atual">...</span>
                    </h1>
                </div>
                <div class="dash-rede-cards-topo">
                    <p class="bold mb-2">Megabytes Recebidos</p>
                    <h1 class="dash-rede-fonte-cards  bold" id="card_mbs_recebidos">
                        <span class="dash-rede-cor-anterior">...</span> x <span class="dash-rede-cor-atual">...</span>
                    </h1>
                </div>
                <div class="dash-rede-cards-topo">
                    <p class="bold mb-2">Erros (E/R)</p>
                    <h1 class="dash-rede-fonte-cards  bold" id="card_erros">
                        <span class="dash-rede-cor-anterior">...</span> x <span class="dash-rede-cor-atual">...</span>
                    </h1>
                </div>
                <div class="dash-rede-cards-topo">
                    <p class="bold mb-2">Descartes (E/R)</p>
                    <h1 class="dash-rede-fonte-cards  bold" id="card_descartes">
                        <span class="dash-rede-cor-anterior">...</span> x <span class="dash-rede-cor-atual">...</span>
                    </h1>
                </div>
            </div>
            <div class="dash-rede-pai">
                <div class="dash-rede-coluna-1">

                    <div class="dash-rede-barchart">
                        <div class="dash-rede-barchart-space">
                            <h4 class="bold mb-2" id="titulo-grafico-barra"><span class="dash-rede-cor-anterior">Semana
                                    <span id="placeholder_semana_anterior">dd/mm/yy</span></span> x <span
                                    class="dash-rede-cor-atual">Semana <span
                                        id="placeholder_semana_atual">dd/mm/yy</span></span></h4>
                            <div style="width: 100%; height: 90%; position: relative;">
                                <canvas class="barplot" id="myBarChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="dash-rede-linRegress">
                        <div class="dash-rede-linRegress-space">
                            <h4 class="bold mb-2">Previsão Por Tendência - Pacotes Env. e Rec.</h4>
                            <div style="width: 100%; height: 90%; position: relative;">
                                <canvas class="" id="regressionChart"></canvas>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="dash-rede-coluna-2">
                    <div class="dash-rede-coluna-2-area-grafico">
                        <div class="area-grafico-rede">
                            <div id="chart" style="width: 100%; height: 100%; margin: 0 auto;"></div>
                        </div>
                    </div>
                    <h4 class="italic bold">Contagem de Alertas</h4>
                    <div class="dash-rede-campo-barra">
                        <h5 class="bold italic">Pacotes (E/R): <span id="alertas_pacotes">...</span></h5>
                        <h5 class="bold italic">Megabytes (E/R): <span id="alertas_megabytes">...</span></h5>
                        <h5 class="bold italic">Erros e Descartes (E/R): <span id="alertas_err_desc">...</span></h5>
                    </div>
                    <h4 class="italic bold">Médias</h4>
                    <div class="dash-rede-campo-barra">
                        <h5 class="bold italic">Pacotes (E/R): <span id="media_pacotes">...</span></h5>
                        <h5 class="bold italic">Megabytes (E/R): <span id="media_megabytes">...</span></h5>
                        <h5 class="bold italic">Erros e Descartes (E/R): <span id="media_err_desc">...</span></h5>
                    </div>

                </div>
            </div>
        </main>
    </section>
</body>
<script>

    const dados = {}
    let myBarChart = null;

    const formatarSemanas = semana => {
        const dataInicio = new Date(semana.inicio_semana);
        const dataFim = new Date(semana.fim_semana);
        return `${dataInicio.toLocaleDateString()} a ${dataFim.toLocaleDateString()}`;
    }

    const formatarData = data => {
        const dataFormatada = new Date(data);
        return dataFormatada.toLocaleDateString();
    }

    const sairNavbar = () => {
        event.preventDefault();
        sessionStorage.clear();
        window.location.href = "../../index.html";
    }

    const voltar = () => {
        window.location.href = "../dashboard-adm.html";

    }

    const obterSemanas = async () => {
        const select = document.querySelector('#select-semana');
        const idEmpresa = sessionStorage.getItem('ID_EMPRESA_USUARIO');

        try {

            const resposta = await fetch(`/empresas/obterSemanas/${idEmpresa}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                },
            });

            if (!resposta.ok) {
                throw new Error(`Erro na requisição: ${resposta.status} - ${resposta.statusText}`);
            }

            const semanas = await resposta.json();

            dados.semanas = semanas;
            select.innerHTML = ""
            semanas.forEach(semana => {
                const option = document.createElement('option');
                option.value = semana.numero_semana;
                option.innerText = formatarSemanas(semana);
                select.appendChild(option);
            });

            if (semanas.length > 0) {
                select.value = semanas[0].numero_semana;
                selecaoSemana();
            }

        } catch (error) {
            console.error('Erro ao obter semanas:', error);
        }
    };


    const atualizarGraficoBarras = valores => {
        if (myBarChart) {
            myBarChart.destroy();
        }

        const dadosAtuais = valores.map(v => v.semanaAtual);
        const dadosAntigos = valores.map(v => v.semanaPassada);

        var ctx = document.querySelector('#myBarChart').getContext('2d');

        const data = {
            labels: ['Pacotes Env.', 'Pacotes Rec.', 'MB Env.', 'MB Rec.', 'Erros', 'Descartes'],
            datasets: [
                {
                    label: `Semana Anterior (${formatarData(dados.semanaAnterior.inicio_semana)})`,
                    data: dadosAntigos,
                    backgroundColor: 'rgba(42, 19, 215, 0.2)',
                    borderColor: 'rgba(42, 19, 215, 1)',
                    borderWidth: 1
                },
                {
                    label: `Semana Selecionada (${formatarData(dados.semana.inicio_semana)})`,
                    data: dadosAtuais,
                    backgroundColor: 'rgba(66, 203, 53, 0.2)',
                    borderColor: 'rgba(66, 203, 53, 1)',
                    borderWidth: 1
                }
            ]
        };

        const config = {
            type: 'bar',
            data: data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        ticks: {
                            color: 'black',
                            font: {
                                size: 11,
                                weight: 'bold'
                            }
                        }
                    },
                    y: {
                        type: 'logarithmic',
                        beginAtZero: true,
                        min: 1,
                        ticks: {
                            display: false
                        },
                        grid: {
                            display: false
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                    }
                },
                barPercentage: 0.8,
                categoryPercentage: 0.9
            }
        };

        myBarChart = new Chart(ctx, config);
    }

    const atualizarCards = numeroSemana => {
        const dadosSemanas = {};

        Promise.all([
            fetch(`/empresas/obterCards/${sessionStorage.getItem("ID_EMPRESA_USUARIO")}/${numeroSemana}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            }).then(resposta => resposta.json().then(respostaFormatada => {

                dadosSemanas.semanaAtual = respostaFormatada[0][0];

            })),
            fetch(`/empresas/obterCards/${sessionStorage.getItem("ID_EMPRESA_USUARIO")}/${numeroSemana - 1}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            }).then(resposta => resposta.json().then(respostaFormatada => {

                dadosSemanas.semanaPassada = respostaFormatada[0][0];

            }))
        ]).then(() => {
            atualizarCardsInterface(dadosSemanas);
        }).catch(error => {
            console.error('Erro ao obter dados:', error);
        });

    }

    const atualizarCardsInterface = dadosSemanas => {
        const cardPacotesEnviados = document.getElementById('card_pacotes_enviados');
        const cardPacotesRecebidos = document.getElementById('card_pacotes_recebidos');
        const cardMbsEnviados = document.getElementById('card_mbs_enviados');
        const cardMbsRecebidos = document.getElementById('card_mbs_recebidos');
        const cardErros = document.getElementById('card_erros');
        const cardDescartes = document.getElementById('card_descartes');

        const semanaPassada = dadosSemanas.semanaPassada;
        const semanaAtual = dadosSemanas.semanaAtual;

        const listaElementos = [cardPacotesEnviados, cardPacotesRecebidos, cardMbsEnviados, cardMbsRecebidos, cardErros, cardDescartes];

        const valores = [
            { semanaPassada: semanaPassada.total_pacotes_enviados, semanaAtual: semanaAtual.total_pacotes_enviados },
            { semanaPassada: semanaPassada.total_pacotes_recebidos, semanaAtual: semanaAtual.total_pacotes_recebidos },
            { semanaPassada: semanaPassada.total_megabytes_enviados, semanaAtual: semanaAtual.total_megabytes_enviados },
            { semanaPassada: semanaPassada.total_megabytes_recebidos, semanaAtual: semanaAtual.total_megabytes_recebidos },
            { semanaPassada: semanaPassada.total_erros, semanaAtual: semanaAtual.total_erros },
            { semanaPassada: semanaPassada.total_descartes, semanaAtual: semanaAtual.total_descartes }
        ];

        listaElementos.forEach((elemento, index) => {
            const valor = valores[index];
            if (valor.semanaPassada >= valor.semanaAtual) {
                var imagemSeta = '<img src="../../assets/svg/arrow-down.svg" alt="">';
            } else {
                var imagemSeta = '<img src="../../assets/svg/arrow-up.svg" alt="">';
            }
            elemento.innerHTML = `<span class="dash-rede-cor-anterior">${parseInt(valor.semanaPassada)}</span> x <span class="dash-rede-cor-atual">${parseInt(valor.semanaAtual)}</span>${imagemSeta}`;
        });

        atualizarGraficoBarras(valores);

    }

    const atualizarMapaInterface = dadosMapa => {

        // Criando um array de datas únicas	
        // Por ser um set, não aceita datas duplicadas
        // ... (spread operator) para transformar o set em array de volta
        // sort para ordenar as datas em ordem crescente
        // map para transformar as datas em objetos
        // exemplo do map: 
        // "2021-09-01" => { name: "01/09/2021", data: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10] }
        const datas = [...new Set(dadosMapa[0].map(dm => dm.data))].sort();

        console.log('DadosMapa', dadosMapa);
        console.log('Datas:', datas);

        // Criando um array de objetos com as datas e os registros do dia
        // para cada data, filtrar os registros do dia
        // e transformar em um objeto com a data e os registros
        // converte os totais para inteiro (os dados já vem com casas decimais 0,
        // mas estou removendo as casas para melhor visualização)
        // e retorna o objeto
        const series = datas.map(data => {
            const registrosDoDia = dadosMapa[0].filter(dm => dm.data === data);
            return {
                name: formatarData(data),
                data: registrosDoDia.map(r => parseInt(r.total_pacotes))
            };
        });
    
        const options = {
            series: series,
            chart: {
                height: 350,
                width: 800,
                type: 'heatmap',
            },
            dataLabels: {
                enabled: false
            },
            colors: ["#6C2BB3"],
            title: {
                text: 'Mapa de Calor - Pacotes (E/R) por Hora',
                offsetY: 15,
                offsetX: 250,
                style: {
                    fontSize: '18px',
                    fontWeight: 'bold'
                }
            },
            xaxis: {
                categories: Array.from({length: 24}, (_, i) => 
                    `${String(i).padStart(2, '0')}:00`
                ),
                title: {
                    text: 'Horas do Dia'
                }
            },
            yaxis: {
                title: {
                    text: 'Dias da Semana'
                }
            }
        };
    
        document.querySelector("#chart").innerHTML = '';
        var chart = new ApexCharts(document.querySelector("#chart"), options);
        chart.render();
    }

    const atualizarMapa = numeroSemana => {
        fetch(`/empresas/obterMapaSemana/${sessionStorage.getItem("ID_EMPRESA_USUARIO")}/${numeroSemana}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        }).then(resposta => resposta.json().then(respostaFormatada => {
            console.log('Mapa de calor:', respostaFormatada);
            atualizarMapaInterface(respostaFormatada);
        })).catch(error => {
            console.error('Erro ao obter mapa de calor:', error);
        });
    }

    const selecaoSemana = () => {
        const select = document.querySelector('#select-semana');
        const semanaNumero = select.value;
        const semanaSelecionada = dados.semanas.find(s => s.numero_semana == semanaNumero);
        const semanaAnterior = dados.semanas.find(s => s.numero_semana == (semanaNumero - 1));
        const inicioSemanaSelecionada = semanaSelecionada.inicio_semana;
        const inicioSemanaAnterior = semanaAnterior.inicio_semana;

        const elementoSemanaAnterior = document.getElementById('semana_anterior_titulo');
        elementoSemanaAnterior.innerHTML = `(${formatarData(inicioSemanaAnterior)})`;


        const elementoTituloGraficoBarras = document.getElementById('titulo-grafico-barra');

        elementoTituloGraficoBarras.innerHTML = `<span class="dash-rede-cor-anterior">Semana <span
                                        id="placeholder_semana_anterior">${formatarData(inicioSemanaAnterior)}</span></span> x <span
                                    class="dash-rede-cor-atual">Semana <span
                                        id="placeholder_semana_atual">${formatarData(inicioSemanaSelecionada)}</span></span></h4>`

        dados.semana = semanaSelecionada;
        dados.semanaAnterior = semanaAnterior;

        atualizarCards(semanaNumero);
        atualizarMapa(semanaNumero);

    }

    function generateData(hours, range) {
        var series = [];
        for (var i = 0; i < hours; i++) {
            var hour = (i % 24) + ":00"; // Representação da hora do dia
            var y = Math.floor(Math.random() * (range.max - range.min + 1)) + range.min;

            series.push({ x: hour, y: y });
        }
        return series;
    }



    // Mock data
    const x_values = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
    const y_values = [1.2, 2.5, 2.8, 4.1, 5.3, 5.9, 7.1, 8.3, 9.0, 10.5];

    // Calculated regression line (mock)
    const y_hat = x_values.map(x => 1.1 * x + 0.2); // Example regression line y = 1.1x + 0.2

    // Create the chart
    var ctx = document.getElementById('regressionChart');
    const mixedChart = new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [
                {
                    type: 'line',
                    label: `Linha de Projeção`,
                    data: x_values.map((x, i) => ({ x, y: y_hat[i] })),
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    borderWidth: 2,
                    tension: 0.3,
                },
                {
                    type: 'scatter',
                    label: 'Valores Reais',
                    data: x_values.map((x, i) => ({ x, y: y_values[i] })),
                    backgroundColor: 'rgb(0, 0, 0)',
                    pointRadius: 5,
                }
            ]
        },
        options: {
            scales: {
                x: {
                    type: 'linear',
                    position: 'bottom',
                    title: {
                        display: true,
                        text: 'X Values'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Y Values'
                    }
                }
            }
        }
    });

    document.onload = obterSemanas();

</script>