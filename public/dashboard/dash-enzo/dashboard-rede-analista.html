<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ServGuard | Dashboard Rede</title>
  <link rel="stylesheet" href="../../css/main.css" />
  <link rel="shortcut icon" href="../../assets/svg/logo-white.svg" type="image/x-icon" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <link rel="stylesheet" href="../dash-enzo/enzo.css">
</head>
<body onload="consultarMaquinas(sessionStorage.getItem('ID_EMPRESA_USUARIO')), buscarUltimosDadosRede(sessionStorage.getItem('ID_EMPRESA_USUARIO')) ">
  <section id="page-rede-analista">
    <header>
      <div class="child-navbar-card-dash-adm">
        <div class="navbar-logo-dash-adm">
          <img src="../../assets/svg/logo.svg" alt="#logo" />
        </div>
        <div class="navbar-navlink-dash-adm">
          <ul class="list-navlink-dash-adm" id="ul-nav">
            <li id="li-adm">
              <a href="../dashboard-adm.html" class="link-dash-adm">
                <img src="../../assets/svg/layout-icon.svg" alt="#icone-layout" />
              </a>
              <p class="little-text">Início</p>
            </li>
            <li>
              <a href="../dashboard-analista.html" class="link-dash-adm">
                <img src="../../assets/svg/search.svg" alt="#icone-layout" />
              </a>
              <p class="little-text">Detalhes</p>
            </li>
            <li id="li-funcionario">
              <a href="../gerenciamento-funcionario.html" class="link-dash-adm">
                <img src="../../assets/svg/func-icon.svg" alt="#icone-funcionario" />
              </a>
              <p class="little-text">Funcionário</p>
            </li>
            <li>
              <a href="../gerenciamento-maquina.html" class="link-dash-adm">
                <img src="../../assets/svg/server-icon.svg" alt="#icone-" />
              </a>
              <p class="little-text">Máquina</p>
            </li>
            <li>
              <a href="../chat-sgi.html" class="link-dash-adm">
                <img src="../../assets/svg/logo-sgi.svg" alt="#icone-" />
              </a>
              <p class="little-text">SGI</p>
            </li>
            <li>
              <a href="detalhes-funcionario.html" class="link-dash-adm">
                <img src="../../assets/svg/perfil-icon.svg" alt="#icone-" />
              </a>
              <p class="little-text">Perfil</p>
            </li>
          </ul>
        </div>
        <a href="#" class="navbar-exit-dash-adm" onclick="sairNavbar()">
          <img src="../../assets/svg/exit-icon.svg" alt="" />
        </a>
      </div>
    </header>
    <main>
      <div class="dash-alert-topo">
        <div class="link-back-seta">
          <a class="bold text-gray-dark" onclick="voltar()">
            <div class="icon-trian"></div> Voltar para início
          </a>
        </div>
        <div class="dash-alert-titulo">
          <h1 class="bold">Monitoramento de Rede:</h1>
          <p style="color: var(--normal-purple);" class="bold italic">Análise em Tempo Real da Conectividade e
            Desempenho de seus Servidores.</p>
        </div>
      </div>
      <div class="container">
        <div class="father-card-group">
          <div class="card-group">
            <div class="card-body-estado">
              <div class="father-tips-enzo">
                <div class="tooltip tooltip-white">
                  <h4>i</h4>
                  <span class="tooltiptext tooltip-left text-black" style="text-align: left;">
                    Nesta área, utilizamos uma métrica para medir a qualidade da rede.
                    Essa ferramenta nos permite classificar a rede em três categorias:
                    Estável, Instável ou com desempenho variável (Oscilante).
                  </span>
                </div>
              </div>
              <div class="card-body-estado-title">
                <p class="card-title">Estado Rede</p>
              </div>
              <h2 class="bold center text-green" id="estado_rede">...</h2>

            </div>

            <div class="card-body-maquinas">
              <div class="father-tips-enzo">
                <div class="tooltip tooltip-white">
                  <h4>i</h4>
                  <span class="tooltiptext tooltip-left text-black" style="text-align: left;">
                    Este card é responsável por monitorar todas as máquinas atualmente conectadas à rede,
                    permitindo o acompanhamento em tempo real do status e da atividade de cada dispositivo integrado ao
                    sistema.
                  </span>
                </div>
              </div>
              <div class="card-body-maquinas-title">
                <p class="card-title center">Máquinas Conectadas</p>
              </div>
              <h2 class="card-text bold" id="funcionamento_maquinas"></h2> 
            </div>
            
            <div class="card-body-perda">
              <div class="father-tips-enzo">
                <div class="tooltip tooltip-white">
                  <h4>i</h4>
                  <span class="tooltiptext tooltip-left text-black" style="text-align: left;">
                    Este card realiza o monitoramento dos pacotes de dados que não chegam ao destino na rede (pacotes
                    perdidos).
                    A análise é feita automaticamente a cada 1 hora
                  </span>
                </div>
              </div>
              <div class="card-body-perda-title">
                <p class="card-title">Perda de Pacotes</p>
              </div>
              <div id="resultadoPerda"><h2 class="card-text bold">X%</h2></div>          
            </div>
          </div>
          <div class="card-group-monitoramento">
            <div class="father-tips">
              <div class="tooltip tooltip-white">
                <h4>i</h4>
                <span class="tooltiptext tooltip-left text-black" style="text-align: left;">
                  Nesta área, é apresentado um gráfico detalhado que visualiza o fluxo de pacotes de dados,
                  tanto enviados quanto recebidos, por todas as máquinas da empresa.
                  Com monitoramento a cada 30 segundos
                </span>
              </div>
            </div>
            <div class="card">
              <div class="card-body">
                <div class="card-body-title">
                  <p class="card-title">Monitoramento de Pacotes</p>
                </div>
                <div class="graph-container" id="#chartPacotes">

                </div>
              </div>
            </div>

          </div>
        </div>
        <div class="father-speed-test">
          <div class="card-body-graph">
            <div class="father-tips-enzo">
              <div class="tooltip tooltip-white">
                <h4>i</h4>
                <span class="tooltiptext tooltip-left text-black" style="text-align: left;">
                  Nesta seção, utilizamos uma métrica específica. Ao clicar no botão "Iniciar",
                   essa métrica obtém o último registro de dados de download e upload da rede.
                    Esses dados, que são coletados a cada hora, são representados graficamente por meio de um medidor (gauge),
                     permitindo uma visualização clara do valor mais recente capturado.           
                       </span>
              </div>
            </div>
            <div class="card-title-speed">
              <h5 class="card-title center">Speed Test</h5>
            </div>
            <div class="ultimodado">
              <h2 id="ultimahoracapturada">...</h2>
            </div>
            <div class="speed-test">
              <div class="download">
                <h5>Download</h5>
                <div id="chartDown" style="max-width: 300px; margin: auto;"></div>
              </div>
              <div class="upload">
                <h5>Upload</h5>
                <div id="chartUp" style="max-width: 300px; margin: auto;"></div>
              </div>
            </div>
            <div class="button-speed-test">
              <button class="start-test" id="iniciar-speed" onclick="Clikado()">Clique Aqui</button>
              <div class="exibir-timer">
                <h4 id="timerInfo"></h4>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </section>
</body>
<script>

  function verificarCargo() {
    var isADM = sessionStorage.getItem("IS_ADM_USUARIO");
    if (isADM !== null && Number(isADM) === 0) {
      document.getElementById('li-adm').style.display = 'none';
      document.getElementById('li-funcionario').style.display = 'none';
      document.getElementById('ul-nav').style.display = 'flex';
    } else {
      document.getElementById('li-adm').style.display = 'flex';
      document.getElementById('li-funcionario').style.display = 'flex';
      document.getElementById('ul-nav').style.display = 'flex';
    }
  }
  function sairNavbar() {
    event.preventDefault();
    sessionStorage.clear();
    window.location.href = "../../index.html";
  }
  function voltar() {
    window.location.href = "../dashboard-analista.html";
  }

 // BOTAO HABILITADO/DESABILITADO

  // Seleciona o botão e o elemento de texto

  function Clikado() {
    
    const button = document.getElementById("iniciar-speed");
    const timerInfo = document.getElementById("timerInfo");

    // Verifica se o botão já está desabilitado
    if (button.disabled) return;

    const disableTime = 30 * 60 * 1000; // 30 minutos em milissegundos
    const endTime = new Date().getTime() + disableTime;

    // Desabilita o botão e altera o texto
    button.disabled = true;
    button.classList.add("disabled");
    button.textContent = "Aguarde...";

    // Chama as funções para buscar os dados
    buscarUltimosDadosUpload();
    buscarUltimosDadosDownload();
    obterUltimoHorario();

    // Atualiza o timer na tela
    const interval = setInterval(() => {
      const currentTime = new Date().getTime();
      const timeLeft = Math.max(0, endTime - currentTime);
      const minutes = Math.floor(timeLeft / (1000 * 60));
      const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

      if (timeLeft <= 0) {
        clearInterval(interval);
        // Reabilita o botão e limpa o texto
        button.disabled = false;
        button.classList.remove("disabled");
        button.textContent = "Clique Aqui";
        timerInfo.textContent = "";
      } else {
        timerInfo.textContent = `Você pode clicar novamente em ${minutes}m ${seconds}s`;
      }
    }, 1000);
  }

  function buscarUltimosDadosRede(idEmpresa) {
    
    fetch(`/recursos/buscarUltimosDadosRede/${idEmpresa}`, {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then((response) => {
        if (!response.ok) {
          throw new Error(`Erro ao buscar dados: ${response.statusText}`);
        }
        response.json().then((data) => {
          console.log("Dados recebidos:", data);
          dados = data[0][0];
          console.log("2 zeros", data[0][0]);
          console.log(
            "Velocidade de Download de Todas as maquinas: ",
            dados.velocidadeDownload
          );
          console.log(
            "Total de maquinas somadas aqui: ",
            dados.totalMaquinas
          );
          // e assim por diante, só usar dados e acessar o valor que quiser. A função já está sendo chamada no onload do body
          const taxaDescarte = ((Number(dados.descartePacotesSaida) + Number(dados.descartePacotesEntrada)) / (Number(dados.pacotesEnviados) + Number(dados.pacotesRecebidos))) * 100

          console.log(`TAXA DE DESCARTE ${taxaDescarte} !!!!!!!!!!!!!!!!!!!!!!`)

          const estadosRede = ["Estável", "Oscilante", "Instável", "..."];

          let numeroEstadoRede = 0

          if (taxaDescarte > 0.5 && taxaDescarte < 2.0) {
            numeroEstadoRede = estadosRede.indexOf("Oscilante");
          } else if (taxaDescarte > 2.0) {
            numeroEstadoRede = estadosRede.indexOf("Instável")
          } else if (taxaDescarte <= 0.5) {
            numeroEstadoRede = estadosRede.indexOf("Estável")
          } else {
            numeroEstadoRede = estadosRede.indexOf("...")
          }

          const estadoRede = estadosRede[numeroEstadoRede]

          console.log(estadoRede, "!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!")

          const elemento_estado_rede = document.getElementById("estado_rede");
          elemento_estado_rede.innerText = estadoRede;

          // Alterar a cor do texto com base no estado da rede
          if (estadoRede == "Oscilante") {
            elemento_estado_rede.style.color = "#cc8400";  // Cor laranja
          } else if (estadoRede == "Instável") {
            elemento_estado_rede.style.color = "#d03333";  // Cor vermelha
          } else if (estadoRede == "Estável") {
            elemento_estado_rede.style.color = "#28bb49";  // Cor verde
          } else {
            elemento_estado_rede.style.color = "#0c0c0c";  // Cor Preto
          }

        });
      })
      .catch((error) => {
        console.error("Erro na requisição:", error);
      });
  }
  
  function consultarMaquinas() {
  const idEmpresa = sessionStorage.getItem("ID_EMPRESA_USUARIO");

  fetch(`/maquinas/listarPorEmpresa/${idEmpresa}`, {
    method: "GET",
    headers: {
      "Content-Type": "application/json",
    },
  })
    .then((response) => response.json())
    .then((data) => {
      // Descomente ou declare a variável totalMaquinasElement
      const totalMaquinasElement = document.getElementById("total_maquinas");
      const funcionamentoMaquinasElement = document.getElementById("funcionamento_maquinas");

      if (totalMaquinasElement) {
        totalMaquinasElement.innerText = data.length;
      }

      const maquinasAtivas = data.filter(
        (maquina) => maquina.isAtiva === 1
      );

      if (funcionamentoMaquinasElement) {
        funcionamentoMaquinasElement.innerText = maquinasAtivas.length;
      }
    })
    .catch((error) => {
      console.error("Erro ao consultar máquinas:", error);
    });
}

function obterUltimoValorDownload() {
    const idEmpresa = sessionStorage.getItem("ID_EMPRESA_USUARIO");
    console.log("ID da empresa:", idEmpresa); // Verifique se o valor está correto
    const element = document.querySelector("#chartDown"); // Confirme que o ID corresponde

    fetch(`/buscarUltimosDadosDownload/${idEmpresa}`, {
      method: "GET",
      headers: { "Content-Type": "application/json" }
    })
      .then(response => {
        console.log("Resposta:", response); // Verifique o status
        if (!response.ok) {
          throw new Error("Erro ao obter dados do servidor.");
        }
        return response.json();
      })
      .catch(error => {
        console.error("Erro ao obter ou processar dados:", error);
      })
      .then((data) => {
        if (data && data.length > 0) {
          const valorDownload = data[0].valor_download; // Acessa o valor de download

          if (valorDownload === null || valorDownload === undefined) {
            console.log("Valor de download não disponível.");
            return;
          }

          // Limpar o conteúdo do elemento do gráfico antes de criar um novo gráfico
          const element = document.querySelector("#chartDown");
          if (element) {
            element.innerHTML = ""; // Remove o conteúdo anterior
          }

          // Configuração do gráfico
          var options = {
            series: [parseFloat(valorDownload)], // Valor dinâmico
            chart: {
              type: "radialBar",
              offsetY: -20,
              sparkline: {
                enabled: true,
              },
            },
            plotOptions: {
              radialBar: {
                startAngle: -90,
                endAngle: 90,
                track: {
                  background: "#e7e7e7",
                  strokeWidth: "97%",
                  margin: 5,
                  dropShadow: {
                    enabled: true,
                    top: 2,
                    left: 0,
                    color: "#794ED4",
                    opacity: 1,
                    blur: 2,
                  },
                },
                dataLabels: {
                  name: {
                    show: false,
                  },
                  value: {
                    offsetY: -2,
                    fontSize: "22px",
                    fontWeight: "bold",
                    color: "black",
                    formatter: function (val) {
                      return val.toFixed(2) + " Mbps"; // Exibe em Mbps
                    },
                  },
                },
              },
            },
            grid: {
              padding: {
                top: -10,
              },
            },
            fill: {
              type: "solid",
              colors: ["#794ED4"], // Cor do gráfico
            },
          };

          // Renderizar o gráfico
          var chartDown = new ApexCharts(element, options);
          chartDown.render();

          return chartDown; // Retorna o objeto do gráfico
        }
      })
      .catch((error) => {
        console.error("Erro ao obter ou processar dados:", error);
      });
  }
  document.addEventListener("DOMContentLoaded", function () {
    obterUltimoValorDownload();
  });


  function obterUltimoValorUpload() {
    const idEmpresa = sessionStorage.getItem("ID_EMPRESA_USUARIO");
    console.log("ID da empresa:", idEmpresa); // Verifique se o valor está correto
    const element = document.querySelector("#chartUp"); // Confirme que o ID corresponde

    fetch(`/buscarUltimosDadosUpload/${idEmpresa}`, {
      method: "GET",
      headers: { "Content-Type": "application/json" }
    })
      .then(response => {
        console.log("Resposta:", response); // Verifique o status
        if (!response.ok) {
          throw new Error("Erro ao obter dados do servidor.");
        }
        return response.json();
      })
      .catch(error => {
        console.error("Erro ao obter ou processar dados:", error);
      })
      .then((data) => {
        if (data && data.length > 0) {
          const valorUpload = data[0].valor_upload; // Acessa o valor de upload

          if (valorUpload === null || valorUpload === undefined) {
            console.log("Valor de upload não disponível.");
            return;
          }

          // Limpar o conteúdo do elemento do gráfico antes de criar um novo gráfico
          const element = document.querySelector("#chartUp");
          if (element) {
            element.innerHTML = ""; // Remove o conteúdo anterior
          }

          // Configuração do gráfico
          var options = {
            series: [parseFloat(valorUpload)], // Valor dinâmico
            chart: {
              type: "radialBar",
              offsetY: -20,
              sparkline: {
                enabled: true,
              },
            },
            plotOptions: {
              radialBar: {
                startAngle: -90,
                endAngle: 90,
                track: {
                  background: "#e7e7e7",
                  strokeWidth: "97%",
                  margin:
                    5,
                  dropShadow: {
                    enabled: true,
                    top: 2,
                    left: 0,

                    color: "#794ED4",
                    opacity: 1,
                    blur: 2,
                  },
                },
                dataLabels: {
                  name: {
                    show: false,
                  },
                  value: {
                    offsetY: -2,
                    fontSize: "22px",
                    fontWeight: "bold",
                    color: "black",
                    formatter: function (val) {
                      return val.toFixed(2) + " Mbps"; // Exibe em Mbps
                    },
                  },
                },
              },
            },
            grid: {
              padding: {
                top: -10,
              },
            },
            fill: {
              type: "solid",
              colors: ["#794ED4"], // Cor do gráfico
            },
          };

          // Renderizar o gráfico
          var chartUp = new ApexCharts(element, options);
          chartUp.render();

          return chartUP; // Retorna o objeto do gráfico
        }
      })
      .catch((error) => {
        console.error("Erro ao obter ou processar dados:", error);
      });
  }
  document.addEventListener("DOMContentLoaded", function () {
    obterUltimoValorUpload();
  });



  function obterUltimosDadosPacotes() {
    const idEmpresa = sessionStorage.getItem("ID_EMPRESA_USUARIO");
    console.log("ID da empresa:", idEmpresa); // Verifique se o valor está correto
    const element = document.querySelector("#chartPacotes"); // Elemento do gráfico

    fetch(`/buscarUltimosDadosPacotes/${idEmpresa}`, {
      method: "GET",
      headers: { "Content-Type": "application/json" }
    })
      .then(response => {
        console.log("Resposta:", response);
        if (!response.ok) {
          throw new Error("Erro ao obter dados do servidor.");
        }
        return response.json();
      })
      .catch(error => {
        console.error("Erro ao obter ou processar dados:", error);
      })
      .then(data => {
        if (data && data.length > 0) {
          // Mapeia os dados para o formato de { x: datetime, y: valor }
          const seriesData = data.map(item => ({
            x: new Date(item.dataHora).getTime(),
            y: item.valor
          }));

          // Limpa o conteúdo anterior do gráfico
          if (element) {
            element.innerHTML = "";
          }

          // Configuração do gráfico
          var options = {
            series: [{
              name: "Pacotes",
              data: seriesData
            }],
            chart: {
              type: "line",
              height: 350,
              animations: {
                enabled: true,
                easing: "linear",
                dynamicAnimation: { speed: 1000 }
              },
              toolbar: { show: false },
              zoom: { enabled: false }
            },
            dataLabels: { enabled: false },
            stroke: { curve: "smooth" },
            xaxis: {
              type: "datetime",
              title: { text: "Data e Hora" }
            },
            yaxis: {
              title: { text: "Quantidade de Pacotes" }
            }
          };

          // Renderiza o gráfico
          var chartPacotes = new ApexCharts(element, options);
          chartPacotes.render();

          return chartPacotes; // Retorna o objeto do gráfico
        }
      })
      .catch(error => {
        console.error("Erro ao processar os dados:", error);
      });
  }

  // Atualiza os dados a cada 30 segundos
  document.addEventListener("DOMContentLoaded", function () {
    obterUltimosDadosPacotes(); // Chamada inicial
    setInterval(obterUltimosDadosPacotes, 30000); // Atualização a cada 30 segundos
  });


  function obterUltimoHorario() {
  const idEmpresa = sessionStorage.getItem("ID_EMPRESA_USUARIO");
  console.log("ID da empresa:", idEmpresa);
    
    // Faz a requisição GET para o servidor
    fetch(`/buscarUltimoHorario/${idEmpresa}`)
      .then(response => {
        if (!response.ok) {
          throw new Error("Erro ao buscar dados do último horário");
        }
        return response.json(); // Retorna os dados em formato JSON
      })
      .then(data => {
        // Verifica se a resposta contém o dado do último horário
        if (data && data.length > 0) {
          const ultimoHorario = data[0].ultima_captura; // Pega o valor do último horário
          // Exibe o valor no h2 dentro da div
          document.getElementById("ultimahoracapturada").innerText = ultimoHorario;
        } else {
          // Caso não haja dados, exibe uma mensagem
          document.getElementById("ultimahoracapturada").innerText = "Nenhum dado encontrado.";
        }
      })
      .catch(error => {
        console.error("Erro ao obter o último horário: ", error);
        // Caso ocorra um erro, exibe uma mensagem de erro
        document.getElementById("ultimahoracapturada").innerText = "Erro ao carregar dados.";
      });
  }

  // Função que busca os dados de perda de pacotes e atualiza a cada 1 hora
function atualizarDadosPerdaDePacotes(idEmpresa) {
    // Função que executa a busca e atualiza a div com os dados
    function buscarDados() {
        recursoModel.buscarPerda(idEmpresa)  // Chama a função do modelo para buscar os dados
            .then((resposta) => {
                // Supondo que o valor de perda de pacotes esteja dentro de `resposta.perdaPacotes`
                const perdaPacotes = resposta.perdaPacotes;  // Acesse o valor da perda de pacotes conforme a resposta
                
                console.log("Dados atualizados de perda de pacotes:", perdaPacotes);
                
                // Atualize a div com o valor de perda de pacotes
                document.getElementById('resultadoPerda').innerHTML = `<h2 class="card-text bold">${perdaPacotes}%</h2>`;
            })
            .catch((erro) => {
                console.log("Erro ao buscar dados de perda de pacotes:", erro);
            });
    }

  // Seleciona o botão e o elemento de texto

  function Clikado() {
    const button = document.getElementById("iniciar-speed");
    const timerInfo = document.getElementById("timerInfo");

    // Verifica se o botão já está desabilitado
    if (button.disabled) return;

    const disableTime = 30 * 60 * 1000; // 30 minutos em milissegundos
    const endTime = new Date().getTime() + disableTime;

    // Desabilita o botão e altera o texto
    button.disabled = true;
    button.classList.add("disabled");
    button.textContent = "Aguarde...";

    // Atualiza o timer na tela
    const interval = setInterval(() => {
      const currentTime = new Date().getTime();
      const timeLeft = Math.max(0, endTime - currentTime);
      const minutes = Math.floor(timeLeft / (1000 * 60));
      const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

      if (timeLeft <= 0) {
        clearInterval(interval);
        // Reabilita o botão e limpa o texto
        button.disabled = false;
        button.classList.remove("disabled");
        button.textContent = "Clique Aqui";
        timerInfo.textContent = "";
      } else {
        timerInfo.textContent = `Você pode clicar novamente em ${minutes}m ${seconds}s`;
      }
    }, 1000);
  }


    // Chama a função imediatamente para pegar os dados ao iniciar
    buscarDados();

    // Agendar a execução da busca a cada 1 hora (3600000 ms)
    setInterval(buscarDados, 3600000);  // 3600000 ms = 1 hora
}


 

</script>