<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ServGuard | Dashboard Alertas</title>
  <link rel="stylesheet" href="../../css/main.css" />
  <link rel="shortcut icon" href="../../assets/svg/logo-white.svg" type="image/x-icon" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <link rel="stylesheet" href="../dash-enzo/enzo.css">
</head>

<body onload="consultarMaquinas(),renderGaugeChart(), buscarUltimosDadosRede() ">
  <section id="page-rede-analista">
    <header>
      <div class="child-navbar-card-dash-adm">
        <div class="navbar-logo-dash-adm">
          <img src="../../assets/svg/logo.svg" alt="#logo" />
        </div>
        <div class="navbar-navlink-dash-adm">
          <ul class="list-navlink-dash-adm">
            <li>
              <a href="../dashboard-adm.html" class="link-dash-adm">
                <img src="../../assets/svg/layout-icon.svg" alt="#icone-layout" />
              </a>
              <p class="little-text">Início</p>
            </li>
            <li>
              <a href="../dashboard-analista.html" class="link-dash-adm">
                <img src="../../assets/svg/search.svg" alt="#icone-layout" />
              </a>
              <p class="little-text">Detalhes</p>
            </li>
            <li>
              <a href="../gerenciamento-funcionario.html" class="link-dash-adm">
                <img src="../../assets/svg/func-icon.svg" alt="#icone-funcionario" />
              </a>
              <p class="little-text">Funcionário</p>
            </li>
            <li>
              <a href="../gerenciamento-maquina.html" class="link-dash-adm">
                <img src="../../assets/svg/server-icon.svg" alt="#icone-" />
              </a>
              <p class="little-text">Máquina</p>
            </li>
            <li>
              <a href="../chat-sgi.html" class="link-dash-adm">
                <img src="../../assets/svg/logo-sgi.svg" alt="#icone-" />
              </a>
              <p class="little-text">SGI</p>
            </li>
            <li>
              <a href="detalhes-funcionario.html" class="link-dash-adm">
                <img src="../../assets/svg/perfil-icon.svg" alt="#icone-" />
              </a>
              <p class="little-text">Perfil</p>
            </li>
          </ul>
        </div>
        <a href="#" class="navbar-exit-dash-adm" onclick="sairNavbar()">
          <img src="../../assets/svg/exit-icon.svg" alt="" />
        </a>
      </div>
    </header>
    <main>
      <div class="dash-alert-topo">
        <div class="link-back-seta">
          <a class="bold text-gray-dark" onclick="voltar()">
            <div class="icon-trian"></div> Voltar para início
          </a>
        </div>
        <div class="dash-alert-titulo">
          <h1 class="bold">Monitoramento de Rede:</h1>
          <p style="color: var(--normal-purple);" class="bold italic">Análise em Tempo Real da Conectividade e
            Desempenho de seus Servidores.</p>
        </div>
      </div>
      <div class="container">
        <div class="father-card-group">
          <div class="card-group">
            <div class="card-body-estado">
              <div class="father-tips">
                <div class="tooltip tooltip-white">
                  <h4>i</h4>
                  <span class="tooltiptext tooltip-left text-black" style="text-align: left;">
                    PENSANDO ...
                  </span>
                </div>
              </div>
              <div class="card-body-estado-title">
                <p class="card-title">Estado Rede</p>
              </div>
              <h2 class="bold center text-green" id="estado_rede">...</h2>

            </div>

            <div class="card-body-maquinas">
              <div class="father-tips">
                <div class="tooltip tooltip-white">
                  <h4>i</h4>
                  <span class="tooltiptext tooltip-left text-black" style="text-align: left;">
                    Este card é responsável por monitorar todas as máquinas atualmente conectadas à rede,
                    permitindo o acompanhamento em tempo real do status e da atividade de cada dispositivo integrado ao
                    sistema.
                  </span>
                </div>
              </div>
              <div class="card-body-maquinas-title">
                <p class="card-title center">Máquinas Conectadas</p>
              </div>
              <h2 class="card-text bold " id="">...</h2>
            </div>

            <div class="card-body-perda">
              <div class="father-tips">
                <div class="tooltip tooltip-white">
                  <h4>i</h4>
                  <span class="tooltiptext tooltip-left text-black" style="text-align: left;">
                    Este card realiza o monitoramento dos pacotes de dados que não chegam ao destino na rede (pacotes
                    perdidos).
                    A análise é feita automaticamente a cada 1 hora
                  </span>
                </div>
              </div>
              <div class="card-body-perda-title">
                <p class="card-title">Perda de Pacotes</p>
              </div>
              <h2 class="card-text bold">X%</h2>
            </div>

          </div>
          <div class="card-group-monitoramento">
             <div class="father-tips">
                <div class="tooltip tooltip-white">
                  <h4>i</h4>
                  <span class="tooltiptext tooltip-left text-black" style="text-align: left;">
                    PENSANDO ...
                  </span>
                </div>
              </div>
            <div class="card">
              <div class="card-body">
                <div class="card-body-title">
                  <p class="card-title">Monitoramento de Pacotes</p>
                </div>
                <div class="graph-container">

                </div>
              </div>
            </div>

          </div>
        </div>
        <div class="father-speed-test">
          <div class="card-body-graph">
            <div class="father-tips">
              <div class="tooltip tooltip-white">
                <h4>i</h4>
                <span class="tooltiptext tooltip-left text-black" style="text-align: left;">
                  PENSANDO ...
                </span>
              </div>
            </div>
            <div class="card-title-speed">
              <h5 class="card-title center">Speed Test</h5>
            </div>
            <div class="speed-test">
              <div class="download">
                <h5>Download</h5>
                <div id="chart1" style="max-width: 300px; margin: auto;"></div>
              </div>
              <div class="upload">
                <h5>Upload</h5>
                  <div id="chart2" style="max-width: 300px; margin: auto;"></div>         
              </div>
            </div>
            <div class="button-speed-test">
               <button class="start-test" id="iniciar-speed" onclick="Clikado()">Clique Aqui</button>
              <p id="timerInfo"></p>
            </div>
          </div>
        </div>
      </div>
    </main>
  </section>
</body>
<script>
  function sairNavbar() {
    event.preventDefault();
    sessionStorage.clear();
    window.location.href = "../../index.html";
  }
  function voltar() {
    window.location.href = "../dashboard-adm.html";

  }

  function obterDados() {

  }
  function buscarUltimosDadosRede(idEmpresa) {
    fetch(`/recursos/buscarUltimosDadosRede/${idEmpresa}`, {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then((response) => {
        if (!response.ok) {
          throw new Error(`Erro ao buscar dados: ${response.statusText}`);
        }
        response.json().then((data) => {
          console.log("Dados recebidos:", data);
          dados = data[0][0];
          console.log("2 zeros", data[0][0]);
          console.log(
            "Velocidade de Download de Todas as maquinas: ",
            dados.velocidadeDownload
          );
          console.log(
            "Total de maquinas somadas aqui: ",
            dados.totalMaquinas
          );
          // e assim por diante, só usar dados e acessar o valor que quiser. A função já está sendo chamada no onload do body
          const taxaDescarte = ((Number(dados.descartePacotesSaida) + Number(dados.descartePacotesEntrada)) / (Number(dados.pacotesEnviados) + Number(dados.pacotesRecebidos))) * 100

          console.log(`TAXA DE DESCARTE ${taxaDescarte} !!!!!!!!!!!!!!!!!!!!!!`)

          const estadosRede = ["Estável", "Oscilante", "Instável", "..."];

          let numeroEstadoRede = 0

          if (taxaDescarte > 0.5 && taxaDescarte < 2.0) {
            numeroEstadoRede = estadosRede.indexOf("Oscilante");
          } else if (taxaDescarte > 2.0) {
            numeroEstadoRede = estadosRede.indexOf("Instável")
          } else if (taxaDescarte <= 0.5) {
            numeroEstadoRede = estadosRede.indexOf("Estável")
          } else {
            numeroEstadoRede = estadosRede.indexOf("...")
          }

          const estadoRede = estadosRede[numeroEstadoRede]

          console.log(estadoRede, "!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!")

          const elemento_estado_rede = document.getElementById("estado_rede");
          elemento_estado_rede.innerText = estadoRede;

          // Alterar a cor do texto com base no estado da rede
          if (estadoRede == "Oscilante") {
            elemento_estado_rede.style.color = "#cc8400";  // Cor laranja
          } else if (estadoRede == "Instável") {
            elemento_estado_rede.style.color = "#d03333";  // Cor vermelha
          } else if (estadoRede == "Estável") {
            elemento_estado_rede.style.color = "#28bb49";  // Cor verde
          } else {
            elemento_estado_rede.style.color = "#0c0c0c";  // Cor Preto
          }

        });
      })
      .catch((error) => {
        console.error("Erro na requisição:", error);
      });
  }

  function renderGaugeChart(selector, value) {
    var options = {
      series: [value], // Valor dinâmico
      chart: {
        type: 'radialBar',
        offsetY: -20,
        sparkline: {
          enabled: true,
        },
      },
      plotOptions: {
        radialBar: {
          startAngle: -90,
          endAngle: 90,
          track: {
            background: "#e7e7e7",
            strokeWidth: "97%",
            margin: 5,
            dropShadow: {
              enabled: true,
              top: 2,
              left: 0,
              color: "#794ED4",
              opacity: 1,
              blur: 2,
            },
          },
          dataLabels: {
            name: {
              show: false,
            },
            value: {
              offsetY: -2,
              fontSize: "22px",
              fontWeight: "bold", // Texto em negrito
              color: "black", // Cor do texto
              formatter: function (val) {
                return val + " Mbps"; // Exibe o valor com "%"
              },
            },
          },
        },
      },
      grid: {
        padding: {
          top: -10,
        },
      },
      fill: {
        type: "solid", // Preenchimento sólido
        colors: ["#794ED4"], // Define a cor roxa
      },
      labels: ["Média de RAM:"], // Label do gráfico
    };

    var chart = new ApexCharts(document.querySelector(selector), options);
    chart.render();

    return chart; // Retorna o objeto do gráfico, caso precise atualizar depois
  }

  // Chamada da função para criar o gráfico
  const chart1 = renderGaugeChart("#chart1", 76);

  function renderGaugeChart(selector, value) {
    var options = {
      series: [value], // Valor dinâmico
      chart: {
        type: 'radialBar',
        offsetY: -20,
        sparkline: {
          enabled: true
        }
      },
      plotOptions: {
        radialBar: {
          startAngle: -90,
          endAngle: 90,
          track: {
            background: "#e7e7e7",
            strokeWidth: '97%',
            margin: 5,
            dropShadow: {
              enabled: true,
              top: 2,
              left: 0,
              color: '#794ED4',
              opacity: 1,
              blur: 2
            }
          },
          dataLabels: {
            name: {
              show: false
            },
            value: {
              offsetY: -2,
              fontSize: '22px',
              fontWeight: 'bold', // Texto em negrito
              color: 'black', // Cor do texto
              formatter: function (val) {
                return val + " Mbps"; // Exibe o valor com "%"
              }
            }
          }
        }
      },
      grid: {
        padding: {
          top: -10
        }
      },
      fill: {
        type: '',
        colors: ['#794ED4'],
      },
      labels: ['Média de RAM:'], // Label do gráfico
    };

    var chart = new ApexCharts(document.querySelector(selector), options);
    chart.render();

    return chart; // Retorna o objeto do gráfico, caso precise atualizar depois
  }

  // Chamada da função para criar o gráfico
  const chart2 = renderGaugeChart("#chart2", 76);


  function consultarMaquinas() {
    const idEmpresa = sessionStorage.getItem("ID_EMPRESA_USUARIO");

    fetch(`/maquinas/listarPorEmpresa/${idEmpresa}`, {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        document.getElementById("total_maquinas").innerText = data.length;

        const maquinasAtivas = data.filter(
          (maquina) => maquina.isAtiva === 1
        );
        document.getElementById("funcionamento_maquinas").innerText =
          maquinasAtivas.length;
      });
  }

  // BOTAO HABILITADO/DESABILITADO

  // Seleciona o botão e o elemento de texto

    function Clikado() {
      const button = document.getElementById("iniciar-speed");
      const timerInfo = document.getElementById("timerInfo");

      // Verifica se o botão já está desabilitado
      if (button.disabled) return;

      const disableTime = 30 * 60 * 1000; // 30 minutos em milissegundos
      const endTime = new Date().getTime() + disableTime;

      // Desabilita o botão e altera o texto
      button.disabled = true;
      button.classList.add("disabled");
      button.textContent = "Aguarde...";

      // Atualiza o timer na tela
      const interval = setInterval(() => {
        const currentTime = new Date().getTime();
        const timeLeft = Math.max(0, endTime - currentTime);
        const minutes = Math.floor(timeLeft / (1000 * 60));
        const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

        if (timeLeft <= 0) {
          clearInterval(interval);
          // Reabilita o botão e limpa o texto
          button.disabled = false;
          button.classList.remove("disabled");
          button.textContent = "Clique Aqui";
          timerInfo.textContent = "";
        } else {
          timerInfo.textContent = `Você pode clicar novamente em ${minutes}m ${seconds}s`;
        }
      }, 1000);
    }



</script>