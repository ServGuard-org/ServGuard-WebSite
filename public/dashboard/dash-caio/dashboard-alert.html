<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ServGuard | Dashboard Alertas</title>
    <link rel="stylesheet" href="../../css/main.css" />
    <link rel="shortcut icon" href="../../assets/svg/logo-white.svg" type="image/x-icon" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body onload="carregarPagina()">
    <section id="page-dashboard-alert">
        <header>
            <div class="child-navbar-card-dash-adm">
                <div class="navbar-logo-dash-adm">
                    <img src="../../assets/svg/logo.svg" alt="#logo" />
                </div>
                <div class="navbar-navlink-dash-adm">
                    <ul class="list-navlink-dash-adm">
                        <li>
                            <a href="../dashboard-adm.html" class="link-dash-adm active">
                                <img src="../../assets/svg/layout-icon-white.svg" alt="#icone-layout" />
                            </a>
                            <p class="little-text mt-1">Início</p>
                        </li>
                        <li>
                            <a href="../dashboard-analista.html" class="link-dash-adm">
                                <img src="../../assets/svg/search.svg" alt="#icone-layout" />
                            </a>
                            <p class="little-text mt-1">Detalhes</p>
                        </li>
                        <li>
                            <a href="../gerenciamento-funcionario.html" class="link-dash-adm">
                                <img src="../../assets/svg/func-icon.svg" alt="#icone-funcionario" />
                            </a>
                            <p class="little-text mt-1">Funcionário</p>
                        </li>
                        <li>
                            <a href="../gerenciamento-maquina.html" class="link-dash-adm">
                                <img src="../../assets/svg/server-icon.svg" alt="#icone-" />
                            </a>
                            <p class="little-text mt-1">Máquina</p>
                        </li>
                        <li>
                            <a href="../detalhes-funcionario.html" class="link-dash-adm">
                                <img src="../../assets/svg/perfil-icon.svg" alt="#icone-" />
                            </a>
                            <p class="little-text mt-1">Perfil</p>
                        </li>
                    </ul>
                </div>
                <a href="#" class="navbar-exit-dash-adm" onclick="sairNavbar()">
                    <img src="../../assets/svg/exit-icon.svg" alt="" />
                </a>
            </div>
        </header>
        <main>
            <div class="dash-alert-topo">
                <h1 class="bold">Monitoramento de alertas:</h1>
                <div class="link-back-seta">
                    <a class="bold text-gray-dark" onclick="voltar()">
                        <div class="icon-trian"></div> Voltar
                    </a>
                </div>
            </div>
            <div class="dash-alert-pai">
                <div class="dash-alert-coluna-1">

                    <h3 class="italic" style="margin-top: 3%;">Ocorrências recentes</h3>
                    <div class="dash-alert-lista-pai">
                        <div class="dash-alert-lista-colunas">
                            <div style="width: 13%;">
                                <h4 class="bold">ID</h4>
                            </div>
                            <div style="width: 70%;">
                                <h4 class="bold">Descrição</h4>
                            </div>
                            <div style="width: 10%;"></div>
                        </div>
                        <div class="dash-alert-lista-scroll" id="dash-alert-lista-pai">
                            <!-- OBJETO -->
                            <!-- <div class="dash-alert-lista-objeto">
                                <div style="width: 13%;">
                                    <h4 class=" italic">1</h4>
                                </div>
                                <div style="width: 70%;">
                                    <p class="italic">Descrição</p>
                                </div>
                                <div style="width: 10%;">
                                    <button class="bold underline italic botao-acao"
                                    onclick="DetalhesMaquina()">Detalhes</button>
                                </div>
                            </div>-->
                        </div>
                    </div>

                    <!-- BARRA DE DISTRIBUICAO -->
                    <h4 class="italic bold">Distribuição de alertas por recurso</h4>
                    <div class="dash-alert-campo-barra">

                    </div>

                </div>
                <div class="dash-alert-coluna-2">
                    <div class="dash-alert-coluna-2-dados">
                        <div class="dados-metade">
                            <h5 class="bold italic">Total de ocorrências de hoje: 
                                <samp id="id_total_ocorrencias" style="font-size: larger;">...</samp>
                            </h5>
                            <h5 class="bold italic">Média de ocorrências por dia:
                                <samp id="id_media_ocorrencias" style="font-size: larger;">...</samp>
                            </h5>
                        </div>
                        <div class="dados-parte-meio"></div>
                        <div class="dados-metade">
                            <h5 class="bold italic">Total de máquinas:
                                <samp id="id_total_maquinas" style="font-size: larger;">...</samp>
                            </h5>
                            <h5 class="bold italic">Irregulares:
                                <samp id="id_irregularidade_maquinas" style="font-size: larger;">...</samp>
                            </h5>
                        </div>
                    </div>
                    <div class="dash-alert-coluna-2-area-grafico">
                        <h3 class="" style="font-weight: 500;">Previsão de tendência diária:</h3>
                        <div class="area-grafico">
                            <p>colocar grafico aqui</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </section>
</body>
<script>
    function sairNavbar() {
        event.preventDefault();
        sessionStorage.clear();
        window.location.href = "../../index.html";
    }
    function voltar(){
        window.location.href = "../dashboard-adm.html";
    }
    function carregarPagina(){
        obterDadosDeApoio1()
        obterDadosDeApoio2()
        carregarListaAlertas()
    }
    function obterDadosDeApoio1(){
        const idEmpresa = sessionStorage.getItem("ID_EMPRESA_USUARIO");
        var totaHoje;
        var mediaA;
        fetch(`/medidas/medidasAlertas/${idEmpresa}`, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then(function (resposta) {
            console.log("Iniciando a busca de dados apoio 1");

            if (resposta.ok) {
              return resposta.json().then((json) => {
                console.log(json);
                totalHoje = json[0].total_capturas_alerta_hoje;
                mediaA = json[0].media_diaria_alertas;
                console.log("Valor captura alerta hoje:", totalHoje);
                console.log("Media alerta diaria:", mediaA);
                
                mediaDiaria = document.getElementById(
                  "id_media_ocorrencias"
                );
                elementoInstabilidade = document.getElementById(
                  "id_total_ocorrencias"
                );
                elementoInstabilidade.innerHTML = totaHoje;
                mediaDiaria.innerHTML = parseInt(mediaA);

                
                valor = parseFloat(elementoInstabilidade.innerText);
                media = parseFloat(mediaDiaria.innerText);
                if (valor < media){
                    // verde
                    elementoInstabilidade.classList.remove(
                      "text-green",
                      "text-red",
                      "text-orange",
                      "text-yellow",
                      "text-gray"
                    );
                    elementoInstabilidade.classList.add("text-green");
                }else if (valor = media){
                    // laranja
                    elementoInstabilidade.classList.remove(
                      "text-green",
                      "text-red",
                      "text-orange",
                      "text-yellow",
                      "text-gray"
                    );
                    elementoInstabilidade.classList.add("text-orange");
                } else if (valor > media){
                    // vermelho
                    elementoInstabilidade.classList.remove(
                      "text-green",
                      "text-red",
                      "text-orange",
                      "text-yellow",
                      "text-gray"
                    );
                    elementoInstabilidade.classList.add("text-red");                  
                }
              });
            } else {
              console.log(
                "Houve um erro ao tentar capturar os dados de irregularidades CPU!"
              );
              document.getElementById("escala-instabilidade").innerHTML =
                "Erro ao obter";
              return null; // Retorna null em caso de erro
            }
          })
          .catch(function (erro) {
            // console.log(erro);
            return null; // Retorna null em caso de erro de conexão
          });
    }
    function obterDadosDeApoio2(){
        const idEmpresa = sessionStorage.getItem("ID_EMPRESA_USUARIO");
        var totalM;
        var totalIrr;
        fetch(`/medidas/escalaInstabilidade/${idEmpresa}`, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then(function (resposta) {
            console.log("Iniciando a busca de dados apoio 2");

            if (resposta.ok) {
              return resposta.json().then((json) => {
                console.log(json);
                totalIrr = json[0].total_maquinas_irregulares;
                totalM = json[0].total_maquinas;
                console.log("Valor capturado total maquinas irregulares:", totalIrr);
                console.log("Valor capturado total maquinas:", totalM);
                
                elementoTotal = document.getElementById(
                  "id_total_maquinas"
                );
                elementoInstabilidade = document.getElementById(
                  "id_irregularidade_maquinas"
                );
                elementoTotal.innerHTML = totalM;
                elementoInstabilidade.innerHTML = totalIrr;

                
                valor = parseFloat(elementoInstabilidade.innerText);
                total = parseFloat(elementoTotal.innerText);
                if (valor < total){
                    // verde
                    elementoInstabilidade.classList.remove(
                      "text-green",
                      "text-red",
                      "text-orange",
                      "text-yellow",
                      "text-gray"
                    );
                    elementoInstabilidade.classList.add("text-green");
                }else if (valor = total){
                    // laranja
                    elementoInstabilidade.classList.remove(
                      "text-green",
                      "text-red",
                      "text-orange",
                      "text-yellow",
                      "text-gray"
                    );
                    elementoInstabilidade.classList.add("text-orange");
                } else if (valor > total){
                    // vermelho
                    elementoInstabilidade.classList.remove(
                      "text-green",
                      "text-red",
                      "text-orange",
                      "text-yellow",
                      "text-gray"
                    );
                    elementoInstabilidade.classList.add("text-red");                  
                }
              });
            } else {
              console.log(
                "Houve um erro ao tentar capturar os dados de irregularidades CPU!"
              );
              document.getElementById("escala-instabilidade").innerHTML =
                "Erro ao obter";
              return null; // Retorna null em caso de erro
            }
          })
          .catch(function (erro) {
            // console.log(erro);
            return null; // Retorna null em caso de erro de conexão
          });
    }

    function carregarListaAlertas() {
      const idEmpresa = sessionStorage.getItem("ID_EMPRESA_USUARIO");
      fetch(`/medidas/listaAlertas/${idEmpresa}`, {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
        },
      })
        .then(function (resposta) {
          console.log("Iniciando a busca dos dados da lista de alertas!");

          if (resposta.ok) {
            console.log(resposta);

            resposta.json().then((json) => {
              console.log(json);
              console.log(JSON.stringify(json));

              var listaMaquina = [];
              var nomeRecurso = [];
              console.log(`Formando a lista:`);
              for (var i = 0; i < json.length; i++) {
                listaMaquina.push(json[i].fkMaquina);
                nomeRecurso.push(json[i].nome);
               
                var textoRecurso;
                if (nomeRecurso[i] == "usoCPU") {
                    textoRecurso = "Parametro de CPU alcançado";
                } else {
                    textoRecurso= "Alerta desconhecido"
                }
               
                adicionarLinha(
                  listaMaquina[i],
                  textoRecurso
                )
              }
              console.log(listaMaquina)
              console.log(nomeRecurso)
              
              function adicionarLinha(id, desc) {
                console.log("Chamou listar alertas!!!")
                
                const elementoPai = document.getElementById("dash-alert-lista-pai");

                const novoElemento = `
                    <div class="dash-alert-lista-objeto">
                        <div style="width: 13%;">
                            <h4 class=" italic">${id}</h4>
                        </div>
                        <div style="width: 65%;">
                            <p class="italic little-text">${desc}</p>
                        </div>
                        <div style="width: 30%;">
                            <button class="bold underline italic botao-acao" onclick="DetalhesMaquina(${id})">Ver Máquina</button>
                        </div>
                    </div>        
                `;
                elementoPai.innerHTML += novoElemento;
            }
            });
          } else {
            console.log(
              "Houve um erro ao tentar capturar os dados do mapa instabilidade!"
            );
          }
        })
        .catch(function (erro) {
          console.log(erro);
        });
      return false;
    }
    function DetalhesMaquina(idMaquina) {
      sessionStorage.setItem("ID_MAQUINA", idMaquina);
      window.location.href = "../details-machine.html";
    }
</script>