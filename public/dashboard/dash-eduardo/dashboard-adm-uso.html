<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ServGuard | Dashboard Uso Geral</title>
    <link rel="stylesheet" href="../../css/main.css" />
    <link
      rel="shortcut icon"
      href="../../assets/svg/logo-white.svg"
      type="image/x-icon"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  </head>

  <body onload="carregarPagina()">
    <section id="page-dashboard-usoGeral">
      <header>
        <div class="child-navbar-card-dash-adm">
          <div class="navbar-logo-dash-adm">
            <img src="../../assets/svg/logo.svg" alt="#logo" />
          </div>
          <div class="navbar-navlink-dash-adm">
            <ul class="list-navlink-dash-adm">
              <li>
                <a href="../dashboard-adm.html" class="link-dash-adm">
                  <img
                    src="../../assets/svg/layout-icon.svg"
                    alt="#icone-layout"
                  />
                </a>
                <p class="little-text">Início</p>
              </li>
              <li>
                <a href="../dashboard-analista.html" class="link-dash-adm">
                  <img src="../../assets/svg/search.svg" alt="#icone-layout" />
                </a>
                <p class="little-text">Detalhes</p>
              </li>
              <li>
                <a
                  href="../gerenciamento-funcionario.html"
                  class="link-dash-adm"
                >
                  <img
                    src="../../assets/svg/func-icon.svg"
                    alt="#icone-funcionario"
                  />
                </a>
                <p class="little-text">Funcionário</p>
              </li>
              <li>
                <a href="../gerenciamento-maquina.html" class="link-dash-adm">
                  <img src="../../assets/svg/server-icon.svg" alt="#icone-" />
                </a>
                <p class="little-text">Máquina</p>
              </li>
              <li>
                <a href="../chat-sgi.html" class="link-dash-adm">
                  <img src="../../assets/svg/logo-sgi.svg" alt="#icone-" />
                </a>
                <p class="little-text">SGI</p>
              </li>
              <li>
                <a href="detalhes-funcionario.html" class="link-dash-adm">
                  <img src="../../assets/svg/perfil-icon.svg" alt="#icone-" />
                </a>
                <p class="little-text">Perfil</p>
              </li>
            </ul>
          </div>
          <a href="#" class="navbar-exit-dash-adm" onclick="sairNavbar()">
            <img src="../../assets/svg/exit-icon.svg" alt="" />
          </a>
        </div>
      </header>
      <main>
        <div class="dash-alert-topo">
          <div class="link-back-seta">
            <a class="bold text-gray-dark" onclick="voltar()">
              <div class="icon-trian"></div>
              Voltar para início
            </a>
          </div>
          <div class="dash-alert-titulo">
            <h1 class="bold">Monitoramento de Uso Geral:</h1>
          </div>
        </div>

        <div class="father-general-use">
          <div class="child-general-use">
            <div class="general-use-content-disco">
              <div class="general-use-father-three">
                <h4 class="bold center">Armazenamento Total da Empresa:</h4>
                <div class="space-disco-info">
                  <div class="info-disco-maquinas">
                    <h5 class="bold">
                      Faixas de Uso de Armazenamento das Máquinas:
                    </h5>
                    <div class="item-faixa">
                      <p class="">Faixa de 100-81%:</p>
                      <div class="space-disco-faixa">
                        <h3 class="bold" id="faixa-disco-alta">0</h3>
                      </div>
                    </div>
                    <div class="item-faixa">
                      <p class="">Faixa de 80-51%:</p>
                      <div class="space-disco-faixa">
                        <h3 class="bold" id="faixa-disco-media">0</h3>
                      </div>
                    </div>
                    <div class="item-faixa">
                      <p class="">Faixa de 50-0%:</p>
                      <div class="space-disco-faixa">
                        <h3 class="bold" id="faixa-disco-baixa">0</h3>
                      </div>
                    </div>
                  </div>

                  <div id="histograma-disco" class="space-graphic-disco"></div>
                </div>
              </div>
            </div>
            <div class="general-use-content-medium">
              <div class="general-use-father-three">
                <h4 class="bold center">
                  Histograma de Uso de Processamento das Máquinas:
                </h4>
                <canvas
                  id="histograma-uso"
                  class="space-graphic"
                  style="height: 280px"
                ></canvas>
              </div>
            </div>
          </div>

          <div class="child-general-use">
            <div class="general-use-content-large">
              <div class="general-use-cards-info">
                <div class="card-info">
                  <h5 class="center">
                    Quantidade de Máquinas com Uso de Processamento Maior que
                    80%
                  </h5>
                  <h1 class="bold center" id="uso-hardware-kpi">...</h1>
                </div>
                <div class="card-info">
                  <h5 class="center">
                    Quantidade de Máquinas com Uso de Disco Maior que 80%
                  </h5>
                  <h1 class="bold center" id="uso-disco-kpi">...</h1>
                </div>
              </div>

              <div class="general-use-father-two">
                <div class="list-machine-menu">
                  <h3>Lista de Máquinas:</h3>
                </div>
                <div class="list-machine-card">
                  <div class="column-machine">
                    <div class="column-item">
                      <p class="little-text bold center">ID</p>
                    </div>
                    <div class="column-item">
                      <p class="little-text bold center">Hostname</p>
                    </div>
                    <div class="column-item">
                      <p class="little-text bold center">Processamento</p>
                    </div>
                    <div class="column-item">
                      <p class="little-text bold center">Uso de Disco</p>
                    </div>
                    <div class="column-item">
                      <p class="little-text bold center">
                        Problabilidade de Sobrecarga
                      </p>
                    </div>
                  </div>

                  <hr class="line-list-machine" />

                  <div class="machine-card-space" id="father-machine-space">
                    <!-- <div class="machine-card">
                      <div class="column-item">
                        <p class="little-text bold">01</p>
                      </div>
                      <div class="column-item">
                        <p class="little-text bold">BOOK-1AMQ3DUG8E</p>
                      </div>
                      <div class="column-item">
                        <p class="little-text bold">80%</p>
                      </div>
                      <div class="column-item">
                        <p class="little-text bold">60%</p>
                      </div>
                      <div class="column-item">
                        <p class="little-text bold">95%</p>
                      </div>
                    </div> -->
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="father-general-use" style="display: none">
          <div
            class="child-analise-uso"
            id="card-analise-uso"
            style="display: none"
          >
            <div class="card-analise-uso">
              <h2 class="center bold">Tendencia de Uso Semanal</h2>
              <div class="cards-space-graphic">
                <div class="graphic-space">
                  <div class="card-graphic-analise"></div>
                </div>
                <div class="sgi-space">
                  <div class="card-sgi-analise"></div>
                </div>
              </div>
              <div class="button-space">
                <button class="btn-dashboard" onclick="fecharAnalise()">
                  Fechar
                </button>
              </div>
            </div>
          </div>
        </div>
      </main>
    </section>

    <script>
      function sairNavbar() {
        event.preventDefault();
        sessionStorage.clear();
        window.location.href = "../index.html";
      }

      function voltar() {
        window.location.href = "../dashboard-adm.html";
      }

      function AnalisedeUso() {
        const analiseUse = document.getElementById("card-analise-uso");
        analiseUse.style.display = "flex";
      }

      function fecharAnalise() {
        const analiseUse = document.getElementById("card-analise-uso");
        analiseUse.style.display = "none";
      }

      function carregarPagina() {
        sessionStorage.removeItem("VOLTAR_PAGINA");
        sessionStorage.setItem("VOLTAR_PAGINA", "D_Alert");
        obterDadosHistogramaUso();
        obterDadosHistogramaDisco();
        buscarFaixasUsoDisco();
        buscarUsoHardwareAlto();
        buscarUsoDiscoAlto();
        listarMaquinaHistorico();
      }

      // ------------------------------------- //            // ------------------------------------- //
      // ------------------------------------- // PARAMETROS // ------------------------------------- //
      // ------------------------------------- //            // ------------------------------------- //

      function buscarUsoHardwareAlto() {
        const idEmpresa = sessionStorage.getItem("ID_EMPRESA_USUARIO");

        fetch(`/medidas/usohardwarealto/${idEmpresa}`, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.json())
          .then((data) => {
            console.log(data);
            // Supondo que 'data.usoHardwareAlto' seja o campo com o número que você quer exibir
            document.getElementById("uso-hardware-kpi").innerText =
              data[0].qtdMaquinas;
          })
          .catch((error) => {
            console.error("Erro ao buscar uso de hardware:", error);
          });
      }

      function buscarUsoDiscoAlto() {
        const idEmpresa = sessionStorage.getItem("ID_EMPRESA_USUARIO");

        fetch(`/medidas/usoDiscoAlto/${idEmpresa}`, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.json())
          .then((data) => {
            console.log(data);
            // Supondo que 'data.usoHardwareAlto' seja o campo com o número que você quer exibir
            document.getElementById("uso-disco-kpi").innerText =
              data[0].qtdMaquinas;
          })
          .catch((error) => {
            console.error("Erro ao buscar uso de disco:", error);
          });
      }

      function buscarFaixasUsoDisco() {
        const idEmpresa = sessionStorage.getItem("ID_EMPRESA_USUARIO");
        const faixaBaixa = document.getElementById("faixa-disco-baixa");
        const faixaMedia = document.getElementById("faixa-disco-media");
        const faixaAlta = document.getElementById("faixa-disco-alta");

        let discUsoBaixo = 0;
        let discUsoMedio = 0;
        let discUsoAlto = 0;

        fetch(`/medidas/usoDiscoMaquinas/${idEmpresa}`, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.json())
          .then((data) => {
            for (let i = 0; i < data.length; i++) {
              if (data[i].capacidadeTotal === 0) {
                return 0;
              } else {
                let porcentagemUso =
                  (Number(data[i].usadoTotal) /
                    Number(data[i].capacidadeTotal)) *
                  100;

                if (porcentagemUso >= 0 && porcentagemUso <= 50) {
                  discUsoBaixo++;
                  console.log("Máquina em uso baixo");
                } else if (porcentagemUso >= 51 && porcentagemUso <= 80) {
                  discUsoMedio++;
                  console.log("Máquina em uso médio");
                } else if (porcentagemUso >= 81 && porcentagemUso <= 100) {
                  discUsoAlto++;
                  console.log("Máquina em uso alto");
                } else {
                  console.log("Erro: valor de uso fora do intervalo esperado");
                }
              }
            }

            faixaBaixa.innerHTML = discUsoBaixo;
            faixaMedia.innerHTML = discUsoMedio;
            faixaAlta.innerHTML = discUsoAlto;
          })
          .catch((error) => {
            console.error("Erro ao buscar uso de disco:", error);
          });
      }

      // ------------------------------------- //           // ------------------------------------- //
      // ------------------------------------- // Z - SCORE // ------------------------------------- //
      // ------------------------------------- //           // ------------------------------------- //

      // Função para calcular a média
      function calcularMedia(valores) {
        const soma = valores.reduce((acc, val) => acc + val, 0);
        return soma / valores.length;
      }

      // Função para calcular o desvio padrão
      function calcularDesvioPadrao(valores, media) {
        const variancia =
          valores.reduce((acc, val) => acc + Math.pow(val - media, 2), 0) /
          valores.length;
        return Math.sqrt(variancia);
      }

      // Função para calcular o z-score
      function calcularZScore(valor, media, desvioPadrao) {
        return (valor - media) / desvioPadrao;
      }

      // Função para calcular a probabilidade acumulada de um z-score
      function calcularProbabilidade(zScore) {
        const tabelaZ = {
          0.0: 0.5,
          0.1: 0.5398,
          0.2: 0.5793,
          0.3: 0.6179,
          0.4: 0.6554,
          0.5: 0.6915,
          0.6: 0.7257,
          0.7: 0.758,
          0.8: 0.7881,
          0.9: 0.8159,
          1.0: 0.8413,
          1.1: 0.8643,
          1.2: 0.8849,
          1.3: 0.9032,
          1.4: 0.9192,
          1.5: 0.9332,
          1.6: 0.9452,
          1.7: 0.9554,
          1.8: 0.9641,
          1.9: 0.9713,
          2.0: 0.9772,
          2.1: 0.9821,
          2.2: 0.9861,
          2.3: 0.9893,
          2.4: 0.9918,
          2.5: 0.9938,
        };

        if (zScore > 2.5) {
          return 0.9994; // Para valores grandes, consideramos quase 100%
        }

        const chave = Math.round(zScore * 10) / 10;
        return tabelaZ[chave] || 0;
      }

      // ------------------------------------- //                     // ------------------------------------- //
      // ------------------------------------- // LISTAGEM DE MÁQUINA // ------------------------------------- //
      // ------------------------------------- //                     // ------------------------------------- //
      function adicionarMaquina(
        idMaquina,
        nome,
        usoProcessamento,
        usoArmazenamento,
        probabilidade
      ) {
        console.log("chamou adicionarMaquina()!!!!!!!!!!!!!!!!");

        const elementoPai = document.getElementById("father-machine-space");

        const novoElemento = `
          <div class="machine-card">
            <div class="column-item">
              <p class="little-text bold">${idMaquina}</p>
            </div>
            <div class="column-item">
              <p class="little-text bold">${nome}</p>
            </div>
            <div class="column-item">
              <p class="little-text bold">${usoProcessamento}</p>
            </div>
            <div class="column-item">
              <p class="little-text bold">${usoArmazenamento}</p>
            </div>
            <div class="column-item">
              <p class="little-text bold">${probabilidade}</p>
            </div>
          </div>
        `;

        elementoPai.innerHTML += novoElemento;
      }

      function listarMaquinaHistorico() {
        const idEmpresa = sessionStorage.getItem("ID_EMPRESA_USUARIO");

        fetch(`/medidas/usoDiscoMaquinas/${idEmpresa}`, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.json())
          .then((data) => {
            console.log(data)
          })
          .catch((error) => {
            console.error("Erro ao buscar uso de disco:", error);
          });
      }

      // ------------------------------------- //          // ------------------------------------- //
      // ------------------------------------- // GRÁFICOS // ------------------------------------- //
      // ------------------------------------- //          // ------------------------------------- //

      function obterDadosHistogramaDisco() {
        const idEmpresa = sessionStorage.getItem("ID_EMPRESA_USUARIO");

        fetch(`/medidas/usoDiscoMaquinas/${idEmpresa}`, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.json())
          .then((data) => {
            console.log(`-------------------------${data[0].capacidadeTotal}`);
            console.log(`-------------------------${data[0].usadoTotal}`);

            let totalArmazenamento = 0;
            let totalUsado = 0;

            data.forEach((maquina) => {
              totalArmazenamento = +maquina.capacidadeTotal;
              totalUsado = +maquina.usadoTotal;
            });

            const percentualUsado = (totalUsado / totalArmazenamento) * 100;
            const percentualLivre = 100 - percentualUsado;

            const dadosMocados = [
              { faixa: "Usado", quantidade: percentualUsado },
              { faixa: "Livre", quantidade: percentualLivre },
            ];

            // Extraindo dados para o gráfico
            const series = dadosMocados.map((dado) => dado.quantidade);
            const labels = dadosMocados.map((dado) => dado.faixa);

            // Definindo cores personalizadas para cada faixa
            const coresPersonalizadas = ["#6D4BC7", "#a6a6a7"]; // Exemplo de cores para "Usado" e "Livre"

            // Configuração do gráfico
            var options = {
              series: series,
              chart: {
                width: 380,
                type: "donut",
              },
              labels: labels,
              plotOptions: {
                pie: {
                  startAngle: -90,
                  endAngle: 270,
                },
              },
              dataLabels: {
                enabled: false,
              },
              fill: {
                type: "gradient",
              },
              legend: {
                formatter: function (val, opts) {
                  return (
                    val + " - " + opts.w.globals.series[opts.seriesIndex] + "%"
                  );
                },
              },
              title: {
                text: "Gráfico de Uso de armazenamento",
              },
              tooltip: {
                y: {
                  formatter: function (val) {
                    return val + "%"; // Adiciona o símbolo de porcentagem ao tooltip
                  },
                },
              },
              colors: coresPersonalizadas, // Definindo as cores
              responsive: [
                {
                  breakpoint: 480,
                  options: {
                    chart: {
                      width: 200,
                    },
                    legend: {
                      position: "bottom",
                    },
                  },
                },
              ],
            };

            // Renderizando o gráfico
            var chart = new ApexCharts(
              document.querySelector("#histograma-disco"),
              options
            );
            chart.render();
          })
          .catch((error) => {
            console.error("Erro ao buscar uso de disco:", error);
          });
      }

      function obterDadosHistogramaUso() {
        const idEmpresa = sessionStorage.getItem("ID_EMPRESA_USUARIO");
        let faixa25 = 0;
        let faixa50 = 0;
        let faixa75 = 0;
        let faixa90 = 0;
        let faixa100 = 0;

        fetch(`/medidas/usoProcessamentoUltimos7/${idEmpresa}`, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.json())
          .then((data) => {
            console.log(data);

            for (let i = 0; i < data.length; i++) {
              let usoProcessamento = Number(data[i].maiorUsoSomadoDividido);

              console.log(
                `Uso processamento da máquina ${i}: ${usoProcessamento}`
              );

              if (usoProcessamento >= 0 && usoProcessamento <= 25) {
                faixa25++;
              } else if (usoProcessamento >= 26 && usoProcessamento <= 50) {
                faixa50++;
              } else if (usoProcessamento >= 51 && usoProcessamento <= 75) {
                faixa75++;
              } else if (usoProcessamento >= 76 && usoProcessamento <= 90) {
                faixa90++;
              } else if (usoProcessamento >= 91 && usoProcessamento <= 100) {
                faixa100++;
              } else {
                console.log("Erro: valor de uso fora do intervalo esperado");
              }
            }

            const dadosMocados = [
              { faixa: "0-25%", quantidade: faixa25 },
              { faixa: "26-50%", quantidade: faixa50 },
              { faixa: "51-75%", quantidade: faixa75 },
              { faixa: "76-90%", quantidade: faixa90 },
              { faixa: "91-100%", quantidade: faixa100 },
            ];

            const labels = dadosMocados.map((item) => item.faixa);
            const dados = dadosMocados.map((item) => item.quantidade);

            const ctx = document
              .getElementById("histograma-uso")
              .getContext("2d");
            const grafico = new Chart(ctx, {
              type: "bar",
              data: {
                labels: labels,
                datasets: [
                  {
                    label: "Máquinas por Faixa de Uso de Hardware",
                    data: dados,
                    backgroundColor: [
                      "#36206d",
                      "#4E2E9E",
                      "#7D5CC5",
                      "#9870FF",
                      "#c090ff",
                    ],
                    barThickness: 152,
                    borderRadius: 5,
                  },
                ],
              },
              options: {
                responsive: true,
                plugins: {
                  legend: {
                    position: "top",
                  },
                },
                scales: {
                  x: {
                    beginAtZero: true,
                  },
                },
              },
            });
          })
          .catch((error) => {
            console.error("Erro ao buscar CPU e RAM das máquinas:", error);
          });
      }
    </script>
  </body>
</html>
