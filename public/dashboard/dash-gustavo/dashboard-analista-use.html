<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ServGuard | Dashboard Detalhes</title>
    <link rel="stylesheet" href="../../css/main.css" />
    <link rel="shortcut icon" href="../../assets/svg/logo-white.svg" type="image/x-icon" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>

<body onload="carregarPagina()">
    <section id="page-dashboard-details-use">
        <header>
            <div class="child-navbar-card-dash-adm">
                <div class="navbar-logo-dash-adm">
                    <img src="../../assets/svg/logo.svg" alt="#logo" />
                </div>
                <div class="navbar-navlink-dash-adm">
                    <ul class="list-navlink-dash-adm">
                        <li>
                            <a href="../dashboard-adm.html" class="link-dash-adm active">
                                <img src="../../assets/svg/layout-icon-white.svg" alt="#icone-layout" />
                            </a>
                            <p class="little-text mt-1">Início</p>
                        </li>
                        <li>
                            <a href="../dashboard-analista.html" class="link-dash-adm">
                                <img src="../../assets/svg/search.svg" alt="#icone-layout" />
                            </a>
                            <p class="little-text mt-1">Detalhes</p>
                        </li>
                        <li>
                            <a href="../gerenciamento-funcionario.html" class="link-dash-adm">
                                <img src="../../assets/svg/func-icon.svg" alt="#icone-funcionario" />
                            </a>
                            <p class="little-text mt-1">Funcionário</p>
                        </li>
                        <li>
                            <a href="../gerenciamento-maquina.html" class="link-dash-adm">
                                <img src="../../assets/svg/server-icon.svg" alt="#icone-" />
                            </a>
                            <p class="little-text mt-1">Máquina</p>
                        </li>
                        <li>
                            <a href="../detalhes-funcionario.html" class="link-dash-adm">
                                <img src="../../assets/svg/perfil-icon.svg" alt="#icone-" />
                            </a>
                            <p class="little-text mt-1">Perfil</p>
                        </li>
                    </ul>
                </div>
                <a href="#" class="navbar-exit-dash-adm" onclick="sairNavbar()">
                    <img src="../../assets/svg/exit-icon.svg" alt="" />
                </a>
            </div>
        </header>
        <main>
            <div class="dash-alert-topo-use">
                <h1 class="bold">Máquina (<span id="hostname"></span>) - ID: <span class="text-purple bold"
                        id="id_maquina">...</span></h1>
                <div class="link-back-seta">
                    <a class="bold text-gray-dark" onclick="voltar()">
                        <div class="icon-trian"></div> Voltar
                    </a>
                </div>
            </div>

            <div class="father-dash-alert-use">

                <div class="dash-alert-coluna-1-use">
                    <div class="dash-alert-titulo-detalhe">
                        <h4 class="bold">Detalhes de Alerta:</h4>
                    </div>
                    <div class="father-dash-lista-alertas">
                        <div class="dash-use-total-medições">
                            <div class="dash-adm-parameter-stability-use">
                                <div class="father-tips">
                                    <div class="tooltip tooltip-white">
                                        <h4>i</h4>
                                        <span class="tooltiptext tooltip-left text-black" style="text-align: left">
                                            Esse campo mostra quantas máquinas foram medidas, que será o mesmo número de máquinas cadastradas.<br />
                                            Logo abaixo é feita a separação de todas as medições, mostrando o total de alertas de CPU e RAM. <br />
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <h4 class="bold" style="margin-top: 2%;">Total de Máquinas Medidas</h4>
                            <!-- <p class="bold" style="margin: 2%; font-size: 45px;">14</p> -->
                            <span class="bold" style="margin: 2%; font-size: 45px;" id="total_maquinas">...</span>
                        </div>
                        <div class="dash-alert-total">
                            <div class="dash-alert-lista-coluna-cpu">
                                <h4 class="bold">Total de alertas de CPU</h4>
                                <p class="bold" style="margin: 2%; font-size: 45px;">8</p>

                            </div>
                            <div class="dash-alert-lista-coluna-ram">
                                <h4 class="bold">Total de alertas de RAM</h4>
                                <p class="bold" style="margin: 2%; font-size: 45px;">6</p>
                            </div>
                        </div>
                        <div class="dash-alert-grafic-box-pai">
                            <div class="dash-alert-grafic-box1">
                                <div class="dash-titulo-gauge1">
                                    <h4 class="bold">Média de uso CPU</h4>
                                </div>
                                <div id="chart1" style="max-width: 300px; margin: auto;"></div>
                            </div>
                            <div class="dash-alert-grafic-box2">
                                <div class="dash-titulo-gauge2">
                                    <h4 class="bold">Média de uso RAM</h4>
                                </div>
                                <div id="chart2" style="max-width: 300px; margin: auto;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- BARRA DE DISTRIBUICAO -->
                    <!-- <h4 class="italic bold">Distribuição de alertas por recurso</h4>
                    <div class="dash-alert-campo-barra">

                    </div> -->

                </div>
                <div class="father-dash-alert-use-2">
                    <div class="dash-alert-coluna-2-use">
                        <div class="dash-alert-titulo-detalhe-2">
                            <h4 class="bold">Histórico de Utilização dos últimos 7 dias:</h4>
                        </div>
                        <div class="dash-alert-coluna-2-heat">
                            <div class="dash-use-mapa-heat" id="chart"
                                style="width: 100%; height: 100%; margin: 0 auto; position: relative;"></div>
                        </div>
                        <div class="dash-alert-titulo-detalhe-componente">
                            <h4 class="bold">Histórico de Utilização de Componente:</h4>
                        </div>
                        <div class="dash-alert-coluna-2-grafic">
                            <div class="area-grafic">

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </section>
</body>
<script>

    const idMaquina = sessionStorage.getItem("ID_MAQUINA");

    idMaquina === null ? Swal.fire({
        icon: "error",
        title: `Falha ao obter o id da máquina!`,
        showConfirmButton: false,
        timer: 1100,
        backdrop: false,
        background: '#EEE9FA'
    }).then(() => {
        window.location.href = "./gerenciamento-maquina.html";
    }) : null;

    function sairNavbar() {
        event.preventDefault();
        sessionStorage.clear();
        window.location.href = "../../index.html";
    }
    function voltar() {
        window.location.href = "../details-machine.html";
    }

    function carregarPagina() {
        sessionStorage.removeItem("VOLTAR_PAGINA");
        sessionStorage.setItem("VOLTAR_PAGINA", "D_Alert");
        consultarMaquina();
        consultarMaquinasFuncionamento();
        // ValidacaoCores(escolhaRecurso)
        obterIrrCPU();
        obterIrrRAM();
        obterEscalaInstabilidade();
        var dataHoje = new Date();
        atualizarMapaInterface(dataHoje);
    }

    function consultarMaquina() {

        fetch(`/maquinas/listarPorId/${idMaquina}`, {
            dataType: 'json',
            contentType: 'application/json',
        })
            .then(response => response.json())
            .then(data => {

                console.log(data[0]);

                document.getElementById("id_maquina").innerHTML = data[0].idMaquina;
                document.getElementById("hostname").innerHTML = data[0].nome;
                document.getElementById("cpu").innerHTML = data[0].modeloCPU;
                document.getElementById("ram").innerHTML = Math.ceil(data[0].capacidadeRAM);
                document.getElementById("apelido").innerHTML = data[0].apelido;
                document.getElementById("nucleos").innerHTML = data[0].qtdNucleosLogicos;
                document.getElementById("usado").innerHTML = parseFloat(data[0].discoUsado).toFixed(2);
                document.getElementById("total").innerHTML = parseFloat(data[0].discoTotal).toFixed(2);

                if (data[0].isAtiva === 1) {
                    document.getElementById("ativar_maquina").style.display = "none";
                    document.getElementById("desativar_maquina").style.display = "block";
                } else {
                    document.getElementById("ativar_maquina").style.display = "block";
                    document.getElementById("desativar_maquina").style.display = "none";
                }

            })
            .catch(error => console.error(error));
    }

    function consultarMaquinasFuncionamento() {
        const idEmpresa = sessionStorage.getItem("ID_EMPRESA_USUARIO");

        fetch(`/maquinas/listarPorEmpresa/${idEmpresa}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            },
        })
            .then((response) => response.json())
            .then((data) => {
                document.getElementById("total_maquinas").innerText = data.length;

                const maquinasAtivas = data.filter(
                    (maquina) => maquina.isAtiva === 1
                );
                document.getElementById("funcionamento_maquinas").innerText = maquinasAtivas.length;
            });
    }


    function obterIrrCPU() {
        const idEmpresa = sessionStorage.getItem("ID_EMPRESA_USUARIO");

        fetch(`/recursos/irregularidade/cpu/${idEmpresa}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            },
        })
            .then(function (resposta) {
                console.log("Iniciando a busca das irregularidades de CPU");

                if (resposta.ok) {
                    return resposta.json().then((json) => {
                        console.log(json);
                        const irrCPU = json[0].qtdCpu;
                        console.log("Valor capturado irrCPU:", irrCPU);
                        document.getElementById("irr_cpu").innerHTML = irrCPU;
                        // document.getElementById("irr_cpu").innerHTML = 25;
                        ValidacaoCores("irregularidadesCPU");
                    });
                } else {
                    console.log(
                        "Houve um erro ao tentar capturar os dados de irregularidades CPU!"
                    );
                    document.getElementById("irr_cpu").innerHTML = "Erro ao obter";
                    return null; // Retorna null em caso de erro
                }
            })
            .catch(function (erro) {
                console.log(erro);
                return null; // Retorna null em caso de erro de conexão
            });
    }

    function obterIrrRAM() {
        const idEmpresa = sessionStorage.getItem("ID_EMPRESA_USUARIO");

        fetch(`/recursos/irregularidade/ram/${idEmpresa}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            },
        })
            .then(function (resposta) {
                console.log("Iniciando a busca das irregularidades de RAM");

                if (resposta.ok) {
                    return resposta.json().then((json) => {
                        console.log(json);
                        const irrRAM = json[0].qtdRam;
                        console.log("Valor capturado irrRAM:", irrRAM);
                        document.getElementById("irr_ram").innerHTML = irrRAM;
                        ValidacaoCores("irregularidadesRAM");
                    });
                } else {
                    console.log(
                        "Houve um erro ao tentar capturar os dados de irregularidades RAM!"
                    );
                    document.getElementById("irr_ram").innerHTML = "Erro ao obter";
                    return null; // Retorna null em caso de erro
                }
            })
            .catch(function (erro) {
                console.log(erro);
                return null; // Retorna null em caso de erro de conexão
            });
    }

    function ValidacaoCores(escolhaRecurso) {
        const elementoIrrCPU = document.getElementById("irr_cpu");
        const elementoIrrRAM = document.getElementById("irr_ram");
        var idHTML;

        if (escolhaRecurso == "irregularidadesCPU") {
            idHTML = elementoIrrCPU;
            valor = parseFloat(idHTML.innerText);
            console.log("idHTML de CPU:", valor);
        } else if (escolhaRecurso == "irregularidadesRAM") {
            idHTML = elementoIrrRAM;
            valor = parseFloat(idHTML.innerText);
            console.log("idHTML de RAM:", valor);
        }

        if (valor <= 0) {
            // verde
            idHTML.classList.remove(
                "text-green",
                "text-red",
                "text-orange",
                "text-yellow",
                "text-gray"
            );
            idHTML.classList.add("text-green");
            // idHTML.innerHTML = idHTML;
        } else if (valor > 0 && valor < 15) {
            // amarelo
            idHTML.classList.remove(
                "text-green",
                "text-red",
                "text-orange",
                "text-yellow",
                "text-gray"
            );
            idHTML.classList.add("text-yellow");
            // idHTML.innerHTML = idHTML;
        } else if (valor >= 15 && valor < 25) {
            // laranja
            idHTML.classList.remove(
                "text-green",
                "text-red",
                "text-orange",
                "text-yellow",
                "text-gray"
            );
            idHTML.classList.add("text-orange");
            // idHTML.innerHTML = idHTML;
        } else if (valor >= 25) {
            // vermelho
            idHTML.classList.remove(
                "text-green",
                "text-red",
                "text-orange",
                "text-yellow",
                "text-gray"
            );
            idHTML.classList.add("text-red");
            // idHTML.innerHTML = idHTML;
        } else {
            // sem cor (teoricamente aqui é impossível)
            idHTML.classList.remove(
                "text-green",
                "text-red",
                "text-orange",
                "text-yellow",
                "text-gray"
            );
            idHTML.classList.add("text-gray");
            // idHTML.innerHTML = idHTML;
        }
    }

    function obterEscalaInstabilidade() {
        const idEmpresa = sessionStorage.getItem("ID_EMPRESA_USUARIO");

        fetch(`/medidas/escalaInstabilidade/${idEmpresa}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            },
        })
            .then(function (resposta) {
                console.log("Iniciando a busca da escala de instabilidade");

                if (resposta.ok) {
                    return resposta.json().then((json) => {
                        console.log(json);
                        const irrPorcentagem = json[0].percentual_irregulares;
                        console.log("Valor capturado irrPorcentagem:", irrPorcentagem);

                        elementoInstabilidade = document.getElementById(
                            "escala-instabilidade-use"
                        );
                        if (irrPorcentagem < 1) {
                            elementoInstabilidade.innerHTML = 0;
                        } else if (irrPorcentagem >= 1 && irrPorcentagem < 25) {
                            elementoInstabilidade.innerHTML = 1;
                        } else if (irrPorcentagem >= 25 && irrPorcentagem < 50) {
                            elementoInstabilidade.innerHTML = 2;
                        } else if (irrPorcentagem >= 50) {
                            elementoInstabilidade.innerHTML = 3;
                        }

                        valor = parseFloat(elementoInstabilidade.innerText);
                        switch (valor) {
                            case 0:
                                // verde
                                elementoInstabilidade.classList.remove(
                                    "text-green",
                                    "text-red",
                                    "text-orange",
                                    "text-yellow",
                                    "text-gray"
                                );
                                elementoInstabilidade.classList.add("text-green");
                                break;
                            case 1:
                                // amarelo
                                elementoInstabilidade.classList.remove(
                                    "text-green",
                                    "text-red",
                                    "text-orange",
                                    "text-yellow",
                                    "text-gray"
                                );
                                elementoInstabilidade.classList.add("text-yellow");
                                break;
                            case 2:
                                // laranja
                                elementoInstabilidade.classList.remove(
                                    "text-green",
                                    "text-red",
                                    "text-orange",
                                    "text-yellow",
                                    "text-gray"
                                );
                                elementoInstabilidade.classList.add("text-orange");
                                break;
                            case 3:
                                // vermelho
                                elementoInstabilidade.classList.remove(
                                    "text-green",
                                    "text-red",
                                    "text-orange",
                                    "text-yellow",
                                    "text-gray"
                                );
                                elementoInstabilidade.classList.add("text-red");
                                break;
                            default:
                                // sem cor (teoricamente aqui é impossível)
                                elementoInstabilidade.classList.remove(
                                    "text-green",
                                    "text-red",
                                    "text-orange",
                                    "text-yellow",
                                    "text-gray"
                                );
                                elementoInstabilidade.classList.add("text-gray");
                                break;
                        }
                    });
                } else {
                    console.log(
                        "Houve um erro ao tentar capturar os dados de irregularidades CPU!"
                    );
                    document.getElementById("escala-instabilidade-use").innerHTML =
                        "Erro ao obter";
                    return null; // Retorna null em caso de erro
                }
            })
            .catch(function (erro) {
                // console.log(erro);
                return null; // Retorna null em caso de erro de conexão
            });
    }

    const formatarData = data => {
        const dataFormatada = new Date(data);
        return dataFormatada.toLocaleDateString();
    }

    function atualizarMapaInterface(dadosMapa) {

        // Criando um array de datas únicas	
        // Por ser um set, não aceita datas duplicadas
        // ... (spread operator) para transformar o set em array de volta
        // sort para ordenar as datas em ordem crescente
        // map para transformar as datas em objetos
        // exemplo do map: 
        // "2021-09-01" => { name: "01/09/2021", data: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10] }
        const datas = [...new Set(dadosMapa[0].map(dm => dm.data))].sort();

        console.log('DadosMapa', dadosMapa);
        console.log('Datas:', datas);

        // Criando um array de objetos com as datas e os registros do dia
        // para cada data, filtrar os registros do dia
        // e transformar em um objeto com a data e os registros
        // converte os totais para inteiro (os dados já vem com casas decimais 0,
        // mas estou removendo as casas para melhor visualização)
        // e retorna o objeto
        const series = datas.map(data => {
            const registrosDoDia = dadosMapa[0].filter(dm => dm.data === data);
            return {
                name: formatarData(data),
                data: registrosDoDia.map(r => parseInt(r.total_pacotes))
            };
        });

        const options = {
            series: series,
            chart: {
                height: 350,
                width: 800,
                type: 'heatmap',
            },
            dataLabels: {
                enabled: false
            },
            colors: ["#6C2BB3"],
            title: {
                text: 'Mapa de Calor - Uso de CPU e RAM',
                offsetY: 15,
                offsetX: 250,
                style: {
                    fontSize: '18px',
                    fontWeight: 'bold'
                }
            },
            xaxis: {
                categories: Array.from({ length: 24 }, (_, i) =>
                    `${String(i).padStart(2, '0')}:00`
                ),
                // title: {
                //     text: 'Horas do Dia'
                // }
            },
            yaxis: {
                title: {
                    text: 'Dias da Semana'
                }
            }
        };

        document.querySelector("#chart").innerHTML = '';
        var chart = new ApexCharts(document.querySelector("#chart"), options);
        chart.render();
    }

    function atualizarMapa(numeroSemana) {
        fetch(`/empresas/obterMapaSemana/${sessionStorage.getItem("ID_EMPRESA_USUARIO")}/${numeroSemana}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        }).then(resposta => resposta.json().then(respostaFormatada => {
            console.log('Mapa de calor:', respostaFormatada);
            atualizarMapaInterface(respostaFormatada);
        })).catch(error => {
            console.error('Erro ao obter mapa de calor:', error);
        });
    }

    function renderGaugeChart(selector, value) {
        var options = {
            series: [value], // Valor dinâmico
            chart: {
                type: 'radialBar',
                offsetY: -20,
                sparkline: {
                    enabled: true,
                },
            },
            plotOptions: {
                radialBar: {
                    startAngle: -90,
                    endAngle: 90,
                    track: {
                        background: "#e7e7e7",
                        strokeWidth: "97%",
                        margin: 5,
                        dropShadow: {
                            enabled: true,
                            top: 2,
                            left: 0,
                            color: "#794ED4",
                            opacity: 1,
                            blur: 2,
                        },
                    },
                    dataLabels: {
                        name: {
                            show: false,
                        },
                        value: {
                            offsetY: -2,
                            fontSize: "22px",
                            fontWeight: "bold", // Texto em negrito
                            color: "black", // Cor do texto
                            formatter: function (val) {
                                return val + "%"; // Exibe o valor com "%"
                            },
                        },
                    },
                },
            },
            grid: {
                padding: {
                    top: -10,
                },
            },
            fill: {
                type: "solid", // Preenchimento sólido
                colors: ["#794ED4"], // Define a cor roxa
            },
            labels: ["Média de RAM:"], // Label do gráfico
        };

        var chart = new ApexCharts(document.querySelector(selector), options);
        chart.render();

        return chart; // Retorna o objeto do gráfico, caso precise atualizar depois
    }

    // Chamada da função para criar o gráfico
    const chart1 = renderGaugeChart("#chart1", 76);

    function renderGaugeChart(selector, value) {
        var options = {
            series: [value], // Valor dinâmico
            chart: {
                type: 'radialBar',
                offsetY: -20,
                sparkline: {
                    enabled: true
                }
            },
            plotOptions: {
                radialBar: {
                    startAngle: -90,
                    endAngle: 90,
                    track: {
                        background: "#e7e7e7",
                        strokeWidth: '97%',
                        margin: 5,
                        dropShadow: {
                            enabled: true,
                            top: 2,
                            left: 0,
                            color: '#794ED4',
                            opacity: 1,
                            blur: 2
                        }
                    },
                    dataLabels: {
                        name: {
                            show: false
                        },
                        value: {
                            offsetY: -2,
                            fontSize: '22px',
                            fontWeight: 'bold', // Texto em negrito
                            color: 'black', // Cor do texto
                            formatter: function (val) {
                                return val + "%"; // Exibe o valor com "%"
                            }
                        }
                    }
                }
            },
            grid: {
                padding: {
                    top: -10
                }
            },
            fill: {
                type: '',
                colors: ['#794ED4'],
            },
            labels: ['Média de RAM:'], // Label do gráfico
        };

        var chart = new ApexCharts(document.querySelector(selector), options);
        chart.render();

        return chart; // Retorna o objeto do gráfico, caso precise atualizar depois
    }

    // Chamada da função para criar o gráfico
    const chart2 = renderGaugeChart("#chart2", 76);



</script>