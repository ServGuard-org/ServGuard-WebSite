<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ServGuard | Ger. Funcionário</title>
    <link rel="stylesheet" href="../css/main.css">
    <link rel="shortcut icon" href="../assets/svg/logo-white.svg" type="image/x-icon" />
    <!-- IMPORTANDO A BIBLIOTECA DO SWEETALERT -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</head>

<body onload="consultarFuncionarios()">
    <!-- ----- TELA PRINCIPAL ----- -->
    <section id="page-gerenciamento-funcionario">
        <header>
            <div class="child-navbar-card-dash-adm">
                <div class="navbar-logo-dash-adm">
                    <img src="../assets/svg/logo.svg" alt="#logo">
                </div>

                <div class="navbar-navlink-dash-adm">
                    <ul class="list-navlink-dash-adm">
                        <li>
                            <a href="./dashboard-adm.html" class="link-dash-adm">
                                <img src="../assets/svg/layout-icon.svg" alt="#icone-layout">
                            </a>
                            <p class="little-text mt-1">Início</p>
                        </li>
                        <li>
                            <a href="./gerenciamento-funcionario.html" class="link-dash-adm active">
                                <img src="../assets/svg/func-icon-white.svg" alt="#icone-funcionario">
                            </a>
                            <p class="little-text mt-1">Funcionário</p>
                        </li>
                        <li>
                            <a href="./gerenciamento-maquina.html" class="link-dash-adm">
                                <img src="../assets/svg/server-icon.svg" alt="#icone-">
                            </a>
                            <p class="little-text mt-1">Máquina</p>
                        </li>
                        <li>
                            <a href="detalhes-funcionario.html" class="link-dash-adm">
                                <img src="../assets/svg/perfil-icon.svg" alt="#icone-">
                            </a>
                            <p class="little-text mt-1">Perfil</p>
                        </li>
                    </ul>
                </div>

                <a href="#" class="navbar-exit-dash-adm" onclick="sairNavbar()">
                    <img src="../assets/svg/exit-icon.svg" alt="">
                </a>
            </div>
        </header>

        <!-- //// FIM NAVBAR //// -->

        <main>
            <!-- <h1 class="titulo-usuario-dash bold">Olá de novo Fernanda!</h1> -->
            <!--queria deixar os textos aqui em italic+bold-->
            <div class="father-funcionario-card">
                <h3 class="bold">Gerenciamento de funcionários:</h3>
                <div class="child-funcionario-card">
                    <p class="bold italic">Total: <span id="num_total">X</span></p>
                </div>
                <div class="child-funcionario-card">
                    <p class="bold italic">Analista: <span id="num_ana">X</span></p>
                </div>
                <div class="child-funcionario-card" style="background-color: var(--dark-purple);">
                    <p class="bold text-white italic">ADM: <span id="num_adms">X</span></p>
                </div>
            </div>
            <div class="father-funcionario-lista">
                <div class="child-funcionario-colunas">
                    <!-- apenas para alinhar -->
                    <a href="#" class="child-elemento-editar"></a>
                    </a>
                    <div class="child-funcionario-elemento-father-colunas">

                        <div class="child-funcionario-elemento-coluna-area-id">
                            <p class="bold">ID</p>
                        </div>
                        <div class="child-funcionario-elemento-coluna-area-nome">
                            <p class="bold">Nome</p>
                        </div>
                        <div class="child-funcionario-elemento-coluna-area-email">
                            <p class="bold">E-mail</p>
                        </div>
                        <div class="child-funcionario-elemento-coluna-area-cargo">
                            <p class="bold">Cargo</p>
                        </div>
                        <div class="child-funcionario-elemento-coluna-area-acao">
                            <p class="bold">Ação</p>
                        </div>
                    </div>
                </div>
                <div class="child-funcionario-father-elemento" id="elemento_funcionario_pai">
                    <!-- INICIO ELEMENTO -->
                    <!-- <div class="child-funcionario-elemento">
                        <a href="#" class="child-elemento-editar" onclick="exibirEditar()">
                            <img src="../assets/svg/edit.svg" alt="#icone-">
                        </a>
                        <div class="child-funcionario-elemento-infos">
                            <div class="child-funcionario-elemento-info-area-id">
                                <p>13</p>
                            </div>
                            <div class="child-funcionario-elemento-info-area-nome">
                                <p>Claudio Alvez</p>
                            </div>
                            <div class="child-funcionario-elemento-info-area-email">
                                <p>claudio.alvez@gmail.com</p>
                            </div>
                            <div class="child-funcionario-elemento-info-area-cargo">
                                <p>Analista</p>
                            </div>
                            <div class="child-funcionario-elemento-info-area-acao">
                                <button class="bold underline italic botao-acao">Ativar</button>
                            </div>
                        </div>
                    </div> -->
                    <!-- FIM ELEMENTO -->
                </div>
            </div>
            <div class="father-funcionario-botao">
                <button class="botao-cadastrar-funcionario" onclick="exibirCadastrar()"><b>Cadastrar</b></button>
            </div>
        </main>
    </section>
    <!-- ----- FIM - TELA PRINCIPAL ----- -->
    <!-- ----- POPUP DE CADASTRO FUNCIONARIO ----- -->
    <section class="sessao-popup" id="popupCadastrar" style="display: none;">
        <div class="father-cadastrar-funcionario">
            <h3 class="bold">Complete os campos:</h3>
            <div class="child-campos">
                <select name="cargo" id="cargo" class="select-cargo">
                    <option selected disabled value="#"><b>Selecione o cargo</b></option>
                    <option value="0">Analista</option>
                    <option value="1">Administrador</option>
                </select>
                <div class="child-input">
                    <a class="icone-input">
                        <img src="../assets/svg/perfil-icon-grey.svg" alt="iconeNome">
                    </a>
                    <input type="text" class="input-popup" placeholder="Nome Completo" id="ipt_nome">
                </div>
                <div class="child-input">
                    <a class="icone-input">
                        <img src="../assets/svg/email-icon-gray.svg" alt="iconeNome">
                    </a>
                    <input type="text" class="input-popup" placeholder="E-mail" id="ipt_email">
                </div>
                <div class="child-input">
                    <a class="icone-input">
                        <img src="../assets/svg/chave-icon-gray.svg" alt="iconeNome">
                    </a>
                    <input type="text" class="input-popup" placeholder="Senha" id="ipt_senha">
                </div>
                <div class="child-input">
                    <a class="icone-input">
                        <img src="../assets/svg/chave-icon-gray.svg" alt="iconeNome">
                    </a>
                    <input type="text" class="input-popup" placeholder="Confirmar senha" id="ipt_confirmar_senha">
                </div>
                <div class="checkbox-wrapper">
                    <input id="terms-checkbox-37" name="checkbox" type="checkbox">
                    <label class="terms-label" for="terms-checkbox-37">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 200 200" class="checkbox-svg">
                            <mask fill="white" id="path-1-inside-1_476_5-37">
                                <rect height="200" width="200"></rect>
                            </mask>
                            <rect mask="url(#path-1-inside-1_476_5-37)" stroke-width="40" class="checkbox-box"
                                height="200" width="200"></rect>
                            <path stroke-width="15" d="M52 111.018L76.9867 136L149 64" class="checkbox-tick"></path>
                        </svg>
                        <span class="label-text">Tem certeza que deseja cadastrar este usuário?</span>
                    </label>
                </div>
            </div>
            <div class="father-popup-botao">
                <button class="botao-cadastrar-executar" onclick="cadastrar()"><b>Cadastrar</b></button>
                <p onclick="sairCadastrar()" class="botao-cadastrar-cancelar italic underline bold">Cancelar
                </p>
            </div>
        </div>
    </section>
    <!-- ----- FIM - POPUP DE CADASTRO FUNCIONARIO ----- -->
    <!-- ----- POPUP DE EDITAR FUNCIONARIO ----- -->
    <section class="sessao-popup" id="popupEditar" style="display: none;">
        <div class="father-editar-funcionario">
            <h3 class="bold">Altere o campo que quiser e clique em "<span
                    style="color: var(--dark-purple);">atualizar</span>"</h3>
            <div class="child-campos">
                <select name="cargo" id="cargo_editar" class="select-cargo">
                    <option selected disabled><b>Selecione o cargo</b></option>
                </select>
                <div class="child-input">
                    <a class="icone-input">
                        <img src="../assets/svg/perfil-icon-grey.svg" alt="iconeNome">
                    </a>
                    <input type="text" class="input-popup" placeholder="Nome Completo" id="ipt_nome_editar">
                </div>
                <div class="child-input">
                    <a class="icone-input">
                        <img src="../assets/svg/email-icon-gray.svg" alt="iconeNome">
                    </a>
                    <input type="text" class="input-popup" placeholder="E-mail" id="ipt_email_editar">
                </div>
            </div>
            <div class="father-popup-botao">
                <button class="botao-cadastrar-executar" onclick="atualizarFuncionario()"><b>Atualizar</b></button>
                <p onclick="sairEditar()" class="botao-cadastrar-cancelar italic underline bold">Sair</p>
            </div>
        </div>
    </section>

</body>
<script>
    function sairNavbar() {
        event.preventDefault();
        sessionStorage.clear();
        window.location.href = "../index.html";
    }

    function exibirCadastrar() {
        document.getElementById('popupCadastrar').style.display = 'flex'; // Exibe o popup corretamente
    }
    function sairCadastrar() {
        document.getElementById('popupCadastrar').style.display = 'none'; // Exibe o popup corretamente
    }
    function exibirEditar() {
        document.getElementById('popupEditar').style.display = 'flex'; // Exibe o popup corretamente
    }
    function sairEditar() {
        const iptNome = document.getElementById("ipt_nome_editar");
        const iptEmail = document.getElementById("ipt_email_editar");
        const editarCargo = document.getElementById("cargo_editar");
        editarCargo.innerHTML = "";
        iptEmail.value = "";
        iptNome.value = "";
        document.getElementById('popupEditar').style.display = 'none'; // Exibe o popup corretamente
    }

    function adicionarFuncionario(idUsuario, nome, email, isAdm, isAtivo) {

        const idLogado = sessionStorage.getItem("ID_USUARIO");

        const elementoPai = document.getElementById("elemento_funcionario_pai");

        const cargo = isAdm ? "Administrador" : "Analista";

        const acao = isAtivo ? `<button class="bold underline italic botao-acao" onclick="inativarFuncionario(${idUsuario})">Inativar</button>` : `<button class="bold underline italic botao-acao" onclick="ativarFuncionario(${idUsuario})">Ativar</button>`

        let novoElemento;

        if (idUsuario == idLogado) {
            novoElemento = `<div class="child-funcionario-elemento" style="color: white">
                        <a href="#" class="child-elemento-editar" onclick="exibirEditar(), editarFuncionario(${idUsuario})">
                            <img src="../assets/svg/edit.svg" alt="#icone-">
                        </a>
                        <div class="child-funcionario-elemento-infos" style="background-color: var(--dark-purple)">
                            <div class="child-funcionario-elemento-info-area-id">
                                <p>${idUsuario}</p>
                            </div>
                            <div class="child-funcionario-elemento-info-area-nome">
                                <p>${nome}</p>
                            </div>
                            <div class="child-funcionario-elemento-info-area-email">
                                <p>${email}</p>
                            </div>
                            <div class="child-funcionario-elemento-info-area-cargo">
                                <p>${cargo}</p>
                            </div>
                            <div class="child-funcionario-elemento-info-area-acao" style="color: white">
                                Indisponível
                            </div>
                        </div>
                    </div>`;
        } else if (idUsuario != idLogado) {
            novoElemento = `<div class="child-funcionario-elemento">
                            <a href="#" class="child-elemento-editar" onclick="exibirEditar(), editarFuncionario(${idUsuario})">
                                <img src="../assets/svg/edit.svg" alt="#icone-">
                            </a>
                            <div class="child-funcionario-elemento-infos">
                                <div class="child-funcionario-elemento-info-area-id">
                                    <p>${idUsuario}</p>
                                </div>
                                <div class="child-funcionario-elemento-info-area-nome">
                                    <p>${nome}</p>
                                </div>
                                <div class="child-funcionario-elemento-info-area-email">
                                    <p>${email}</p>
                                </div>
                                <div class="child-funcionario-elemento-info-area-cargo">
                                    <p>${cargo}</p>
                                </div>
                                <div class="child-funcionario-elemento-info-area-acao">
                                    ${acao}
                                </div>
                            </div>
                        </div>`;
        }

        elementoPai.innerHTML += novoElemento;
    }

    function consultarFuncionarios() {

        const idEmpresa = sessionStorage.getItem("ID_EMPRESA_USUARIO");

        fetch(`/usuarios/listarPorEmpresa/${idEmpresa}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            }
        }).then((resposta) => {
            console.log("Resposta: ", resposta);

            if (resposta.ok) {
                resposta.json().then(jsonResposta => {

                    let contAdm = 0;
                    let contAna = 0;
                    let totalFunc = 0;

                    jsonResposta.forEach(elemento => {
                        adicionarFuncionario(elemento.idUsuario, elemento.nome, elemento.email, elemento.isAdm, elemento.isAtivo)

                        if (elemento.isAdm) {
                            contAdm++;
                        } else {
                            contAna++;
                        }

                    });

                    const elementoNumAdms = document.getElementById("num_adms");
                    const elementoNumAna = document.getElementById("num_ana");
                    const elementoNumTotal = document.getElementById("num_total");

                    totalFunc = contAdm + contAna;

                    elementoNumAdms.innerHTML = contAdm;
                    elementoNumAna.innerHTML = contAna;
                    elementoNumTotal.innerHTML = totalFunc;

                })
            } else {
                throw "Houve um erro ao tentar listar funcionários!";
            }
        }).catch((erro) => {
            console.log(`#ERRO: ${erro}`);
            // alerta branco
            Swal.fire({
                icon: "error",
                title: "Oops...",
                text: "Houve um erro ao tentar listar funcionários!",
                color: '#1D1D1F',
                background: '#EEE9FA',
                confirmButtonColor: '#4E2E9E',
            });
        });

    }

    function ativarFuncionario(idUsuario) {
        fetch(`/usuarios/ativar/${idUsuario}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            }
        }).then(resposta => {
            if (resposta.ok) {
                Swal.fire({
                    position: "bottom-end",
                    icon: "success",
                    title: `Funcionário de id: ${idUsuario} Ativado com Sucesso!`,
                    showConfirmButton: false,
                    timer: 1100,
                    backdrop: false,
                    background: '#EEE9FA'
                });
                document.getElementById("elemento_funcionario_pai").innerHTML = ""
                consultarFuncionarios();
            } else {
                throw 'Falha ao ativar funcionario';
            }
        }).catch(err => {
            Swal.fire({
                position: "bottom-end",
                icon: "error",
                title: `Falha ao Ativar funcionário de id: ${idUsuario}!`,
                showConfirmButton: false,
                timer: 1100,
                backdrop: false,
                background: '#EEE9FA'
            });
        })
    }

    function inativarFuncionario(idUsuario) {
        fetch(`/usuarios/inativar/${idUsuario}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
            }
        }).then(resposta => {
            if (resposta.ok) {
                Swal.fire({
                    position: "bottom-end",
                    icon: "success",
                    title: `Funcionário de id: ${idUsuario} Inativado com Sucesso!`,
                    showConfirmButton: false,
                    timer: 1100,
                    backdrop: false,
                    background: '#EEE9FA'
                });
                document.getElementById("elemento_funcionario_pai").innerHTML = ""
                consultarFuncionarios();
            } else {
                throw 'Falha ao inativar funcionario';
            }
        }).catch(err => {
            Swal.fire({
                position: "bottom-end",
                icon: "error",
                title: `Falha ao inativar funcionário de id: ${idUsuario}!`,
                showConfirmButton: false,
                timer: 1100,
                backdrop: false,
                background: '#EEE9FA'
            });
        })
    }

    function cadastrar() {
        const checkConfirma = document.getElementById("terms-checkbox-37").checked;

        if (checkConfirma) {
            const senha = document.getElementById("ipt_senha").value;
            const confirmarSenha = document.getElementById("ipt_confirmar_senha").value;
            if (senha == confirmarSenha) {
                const nome = document.getElementById("ipt_nome").value;
                const email = document.getElementById("ipt_email").value;
                const cargo = document.getElementById("cargo").value;

                if (cargo != '#') {

                    const isAdm = Number(cargo);

                    if (nome && email) {

                        const idEmpresa = sessionStorage.getItem("ID_EMPRESA_USUARIO")

                        cadastrarUsuario(nome, email, senha, isAdm, idEmpresa)

                    } else {
                        Swal.fire({
                            icon: "error",
                            title: "Campos Faltantes",
                            text: "Verifique se todos os campos estão preenchidos",
                            color: '#1D1D1F',
                            background: '#EEE9FA',
                            confirmButtonColor: '#4E2E9E',
                        });
                    }

                } else {
                    Swal.fire({
                        icon: "error",
                        title: "Cargo Não selecionado",
                        text: "Selecione um cargo para o novo usuário",
                        color: '#1D1D1F',
                        background: '#EEE9FA',
                        confirmButtonColor: '#4E2E9E',
                    });
                }


            } else {
                Swal.fire({
                    icon: "error",
                    title: "Senhas Diferentes",
                    text: "Verifique se os campos contém a mesma senha",
                    color: '#1D1D1F',
                    background: '#EEE9FA',
                    confirmButtonColor: '#4E2E9E',
                });
            }
        } else {
            Swal.fire({
                icon: "error",
                title: "Verifique a Caixa de Marcação",
                color: '#1D1D1F',
                background: '#EEE9FA',
                confirmButtonColor: '#4E2E9E',
            });
        }

    }

    function cadastrarUsuario(nome, email, senha, isAdm, idEmpresa) {

        fetch("/usuarios/cadastrar", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                tipoUsuarioServer: isAdm,
                nomeServer: nome,
                emailServer: email,
                senhaServer: senha,
                cnpjServer: undefined,
                idEmpresaServer: idEmpresa
            }),
        }).then(resposta => {
            console.log("Resposta: ", resposta);

            if (resposta.ok) {
                Swal.fire({
                    icon: "success",
                    title: "Cadastro Realizado com Sucesso!",
                    color: '#1D1D1F',
                    background: '#EEE9FA',
                });
                document.getElementById("elemento_funcionario_pai").innerHTML = ""
                consultarFuncionarios();
                sairCadastrar();
            }
        })

    }

    var idUsuarioEditar;

    function editarFuncionario(idUsuario) {

        idUsuarioEditar = idUsuario;

        fetch(`/usuarios/consultarPorId/${idUsuario}`, {
            headers: {
                "Content-Type": "application/json",
            }
        }).then(respostaBruta => {
            if (respostaBruta.ok) {

                respostaBruta.json().then(resposta => {

                    const iptNome = document.getElementById("ipt_nome_editar");
                    const iptEmail = document.getElementById("ipt_email_editar");
                    const editarCargo = document.getElementById("cargo_editar");

                    editarCargo.innerHTML = "";
                    iptEmail.value = "";
                    iptNome.value = "";

                    if (resposta.isAdm == 1) {
                        editarCargo.innerHTML += `<option value="0">Analista</option>`;
                        editarCargo.innerHTML += `<option selected value="1">Administrador</option>`;
                    } else {
                        editarCargo.innerHTML += `<option selected value="0">Analista</option>`
                        editarCargo.innerHTML += `<option value="1">Administrador</option>`
                    }

                    iptEmail.value = resposta.email;
                    iptNome.value = resposta.nome;


                })
            } else {
                Swal.fire({
                    icon: "error",
                    title: "Falha ao Acessar Menu de Edição!",
                    color: '#1D1D1F',
                    background: '#EEE9FA',
                    confirmButtonColor: '#4E2E9E',
                });
            }
        }).catch(error => {
            console.log("Erro! ", error)
        })


    }

    function atualizarFuncionario() {

        const iptNome = document.getElementById("ipt_nome_editar");
        const iptEmail = document.getElementById("ipt_email_editar");
        const editarCargo = document.getElementById("cargo_editar");

        const nome = iptNome.value;
        const email = iptEmail.value;
        const cargo = editarCargo.value;

        const idEmpresa = sessionStorage.getItem("ID_EMPRESA_USUARIO");

        fetch("/usuarios/alterar", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                nome: nome,
                email: email,
                isAdm: cargo,
                idUsuario: idUsuarioEditar,
            })
        }).then(resposta => {

            if (resposta.ok) {
                document.getElementById("elemento_funcionario_pai").innerHTML = ""
                consultarFuncionarios();
                Swal.fire({
                    icon: "success",
                    title: "Dados Alterados Com Sucesso!",
                    text: `Id de funcionário editado: ${idUsuarioEditar}`,
                    color: '#1D1D1F',
                    background: '#EEE9FA',
                    confirmButtonColor: '#4E2E9E',
                });
                sairEditar();
            } else {
                Swal.fire({
                    icon: "error",
                    title: "Falha ao Alterar Dados!",
                    text: `Id de funcionário editado: ${idUsuarioEditar}`,
                    color: '#1D1D1F',
                    background: '#EEE9FA',
                    confirmButtonColor: '#4E2E9E',
                });
            }
        }).catch(error => {
            console.log("Erro! ", error)
        })

    }

</script>

</html>